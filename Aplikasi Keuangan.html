<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Aplikasi</title>
    <!-- Memuat Tailwind CSS -->
    <script src="3.4.17.js"></script>

    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="all.min.css">
    <!-- Pustaka SheetJS untuk file XLSX & CSV -->
    <script src="xlsx.full.min.js"></script>
    <!-- Pustaka Chart.js untuk diagram -->
    <script src="chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Animasi fade-in sederhana */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        /* Styling untuk sidebar mobile */
        .sidebar-mobile {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-mobile.open {
            transform: translateX(0);
        }
        /* Styling untuk kartu header dasbor */
        .header-card {
            background-image: linear-gradient(135deg, var(--tw-gradient-from), var(--tw-gradient-to));
            color: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
        }
        .header-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 antialiased">
    
    <div class="flex h-screen bg-slate-50">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 fixed inset-y-0 left-0 z-30 md:relative md:translate-x-0 flex flex-col bg-[#111827] text-white shadow-lg sidebar-mobile">
            <div class="flex items-center justify-between h-16 border-b border-slate-700 px-4">
                 <span class="text-xl font-bold">LOGO APLIKASI</span>
                 <button id="close-menu-button" class="md:hidden text-slate-300 focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav id="sidebar-nav" class="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-md transition-all duration-200 ease-in-out" data-page="dashboard">
                    <i class="fas fa-home w-5 text-center mr-3"></i>
                    Dashboard
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-md transition-all duration-200 ease-in-out hover:bg-slate-700" data-page="kasir">
                    <i class="fas fa-cash-register w-5 text-center mr-3"></i>
                    Kasir
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-md transition-all duration-200 ease-in-out hover:bg-slate-700" data-page="transaksi">
                    <i class="fas fa-landmark w-5 text-center mr-3"></i>
                    Transaksi
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-md transition-all duration-200 ease-in-out hover:bg-slate-700" data-page="hutang-piutang">
                    <i class="fas fa-hand-holding-usd w-5 text-center mr-3"></i>
                    Hutang Piutang
                </a>
                 <a href="#" class="nav-link flex items-center px-4 py-2 rounded-md transition-all duration-200 ease-in-out hover:bg-slate-700" data-page="produk">
                    <i class="fas fa-box w-5 text-center mr-3"></i>
                    Produk
                </a>
                 <a href="#" class="nav-link flex items-center px-4 py-2 rounded-md transition-all duration-200 ease-in-out hover:bg-slate-700" data-page="laporan">
                    <i class="fas fa-chart-pie w-5 text-center mr-3"></i>
                    Laporan
                </a>
                <a href="#" class="nav-link flex items-center px-4 py-2 rounded-md transition-all duration-200 ease-in-out hover:bg-slate-700" data-page="pengaturan">
                    <i class="fas fa-cog w-5 text-center mr-3"></i>
                    Pengaturan
                </a>
            </nav>
            <!-- Kartu Saldo Akun -->
            <div class="px-4 py-2 mt-auto border-t border-slate-700">
                <h3 class="text-xs font-semibold text-slate-400 mb-2 tracking-wider uppercase">Saldo Akun</h3>
                <div id="sidebar-akun-list" class="space-y-1">
                    <!-- Saldo akan dimuat di sini oleh JavaScript -->
                </div>
            </div>
        </aside>
        
        <!-- Overlay untuk mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
             <!-- Top Bar -->
            <header class="p-4 bg-white border-b border-gray-200 shadow-sm">
                 <div class="flex justify-between items-center space-x-4">
                    <div class="flex items-center flex-shrink-0">
                        <button id="mobile-menu-button" class="text-gray-600 focus:outline-none md:hidden mr-4">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                    </div>
                    <!-- Kartu Header -->
                    <div id="dashboard-header-cards" class="hidden xl:grid grid-cols-6 gap-2 flex-1">
                        <!-- Card 1: Total Saldo -->
                        <div class="header-card from-sky-500 to-sky-700 !p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium">Total Saldo</span>
                                <i class="fas fa-university text-lg opacity-70"></i>
                            </div>
                            <p id="total-saldo-value" class="text-xl font-bold mt-1 truncate">0</p>
                        </div>
                        <!-- Card 2: Saldo Tanpa Piutang -->
                        <div class="header-card from-blue-500 to-blue-700 !p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium">Tanpa Piutang</span>
                                <i class="fas fa-wallet text-lg opacity-70"></i>
                            </div>
                            <p id="saldo-tanpa-piutang-value" class="text-xl font-bold mt-1 truncate">0</p>
                        </div>
                        <!-- Card 3: Total Cash -->
                        <div class="header-card from-emerald-500 to-emerald-700 !p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium">Total Kas</span>
                                <i class="fas fa-money-bill-wave text-lg opacity-70"></i>
                            </div>
                            <p id="total-cash-value" class="text-xl font-bold mt-1 truncate">0</p>
                        </div>
                        <!-- Card 4: Modal -->
                        <div class="header-card from-indigo-500 to-indigo-700 !p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium">Modal</span>
                                <i class="fas fa-briefcase text-lg opacity-70"></i>
                            </div>
                            <p id="modal-value" class="text-xl font-bold mt-1 truncate">0</p>
                        </div>
                        <!-- Card 5: Laba Bersih -->
                        <div class="header-card from-green-500 to-green-700 !p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium">Laba Bersih</span>
                                <i class="fas fa-chart-line text-lg opacity-70"></i>
                            </div>
                            <p id="laba-bersih-value" class="text-xl font-bold mt-1 truncate">0</p>
                        </div>
                        <!-- Card 6: Piutang -->
                        <div class="header-card from-rose-500 to-rose-700 !p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium">Piutang</span>
                                <i class="fas fa-hand-holding-usd text-lg opacity-70"></i>
                            </div>
                            <p id="piutang-value" class="text-xl font-bold mt-1 truncate">0</p>
                        </div>
                    </div>
                 </div>
            </header>
            
            <!-- Area Konten Utama -->
            <div id="main-content" class="flex-1 p-4 md:p-6 overflow-y-auto bg-slate-100">
                <!-- Konten dinamis akan dimuat di sini oleh JavaScript -->
            </div>
        </main>
    </div>

    <!-- Modal generik untuk item sederhana -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md animate-fade-in">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Edit Item</h3>
            <input type="text" id="modal-input" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="modal-save" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Simpan</button>
            </div>
        </div>
    </div>
    
    <!-- Modal khusus untuk Akun -->
    <div id="akun-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md animate-fade-in">
            <h3 id="akun-modal-title" class="text-xl font-bold mb-4">Edit Akun</h3>
            <div class="space-y-4">
                <div>
                    <label for="akun-modal-input-name" class="block text-sm font-medium text-gray-700">Nama Akun</label>
                    <input type="text" id="akun-modal-input-name" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div>
                    <label for="akun-modal-input-balance" class="block text-sm font-medium text-gray-700">Saldo Awal</label>
                    <input type="number" id="akun-modal-input-balance" placeholder="0" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="akun-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="akun-modal-save" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal khusus untuk Hutang -->
    <div id="hutang-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg animate-fade-in">
            <h3 id="hutang-modal-title" class="text-xl font-bold mb-4">Tambah Hutang Baru</h3>
            <form id="hutang-form" class="space-y-4">
                <input type="hidden" id="hutang-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="hutang-tanggal" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="date" id="hutang-tanggal" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                     <div>
                        <label for="hutang-nama" class="block text-sm font-medium text-gray-700">Nama Penghutang</label>
                        <input type="text" id="hutang-nama" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                </div>
                <div>
                    <label for="hutang-sumber-akun" class="block text-sm font-medium text-gray-700">Sumber Akun</label>
                    <select id="hutang-sumber-akun" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                </div>
                <div>
                    <label for="hutang-jumlah" class="block text-sm font-medium text-gray-700">Total Tagihan</label>
                    <input type="number" id="hutang-jumlah" placeholder="0" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div>
                    <label for="hutang-catatan" class="block text-sm font-medium text-gray-700">Catatan (Opsional)</label>
                    <textarea id="hutang-catatan" rows="2" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
                </div>
            </form>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="hutang-modal-cancel" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="hutang-modal-save" type="button" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Simpan</button>
            </div>
        </div>
    </div>
    
    <!-- Modal khusus untuk Produk -->
    <div id="produk-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md animate-fade-in">
            <h3 id="produk-modal-title" class="text-xl font-bold mb-4">Edit Produk</h3>
            <div class="space-y-4">
                <div>
                    <label for="produk-modal-input-name" class="block text-sm font-medium text-gray-700">Nama Produk</label>
                    <input type="text" id="produk-modal-input-name" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="produk-modal-input-modal" class="block text-sm font-medium text-gray-700">Harga Modal</label>
                        <input type="number" id="produk-modal-input-modal" placeholder="0" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                     <div>
                        <label for="produk-modal-input-jual" class="block text-sm font-medium text-gray-700">Harga Jual</label>
                        <input type="number" id="produk-modal-input-jual" placeholder="0" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                </div>
                <div>
                    <label for="produk-modal-input-stok" class="block text-sm font-medium text-gray-700">Stok</label>
                    <input type="number" id="produk-modal-input-stok" placeholder="0" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="produk-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="produk-modal-save" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Edit Transaksi -->
    <div id="transaksi-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg animate-fade-in">
            <h3 id="transaksi-edit-modal-title" class="text-xl font-bold mb-4">Edit Transaksi</h3>
            <div id="transaksi-edit-modal-body" class="space-y-4">
                <!-- Form dinamis akan di-inject di sini -->
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="transaksi-edit-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="transaksi-edit-modal-save" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Tambah Transaksi Keuangan -->
    <div id="transaksi-keuangan-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg animate-fade-in">
            <h3 id="transaksi-keuangan-modal-title" class="text-xl font-bold mb-4">Tambah Transaksi Keuangan</h3>
            <form id="transaksi-keuangan-form" class="space-y-4">
                <input type="hidden" id="tk-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tk-tanggal" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="date" id="tk-tanggal" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label for="tk-tipe" class="block text-sm font-medium text-gray-700">Tipe Transaksi</label>
                        <select id="tk-tipe" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="Pendapatan">Pendapatan</option>
                            <option value="Pengeluaran">Pengeluaran</option>
                            <option value="Transfer">Transfer</option>
                        </select>
                    </div>
                </div>
                <div id="tk-transfer-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="tk-dari-akun" class="block text-sm font-medium text-gray-700">Dari Akun</label>
                        <select id="tk-dari-akun" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    </div>
                     <div>
                        <label for="tk-ke-akun" class="block text-sm font-medium text-gray-700">Ke Akun</label>
                        <select id="tk-ke-akun" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    </div>
                </div>
                 <div id="tk-single-account-field">
                     <div>
                        <label for="tk-akun" class="block text-sm font-medium text-gray-700">Akun</label>
                        <select id="tk-akun" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div id="tk-kategori-container">
                        <label for="tk-kategori" class="block text-sm font-medium text-gray-700">Kategori</label>
                        <select id="tk-kategori" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"></select>
                    </div>
                    <div>
                        <label for="tk-jumlah" class="block text-sm font-medium text-gray-700">Jumlah</label>
                        <input type="number" id="tk-jumlah" placeholder="0" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                </div>
                 <div>
                    <label for="tk-catatan" class="block text-sm font-medium text-gray-700">Catatan (Opsional)</label>
                    <textarea id="tk-catatan" rows="2" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500"></textarea>
                </div>
            </form>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="tk-modal-cancel" type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="tk-modal-save" type="button" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">Simpan</button>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm animate-fade-in">
            <h3 id="confirmation-modal-title" class="text-xl font-bold mb-4 text-gray-800">Konfirmasi Hapus</h3>
            <p id="confirmation-modal-message" class="text-gray-600 mb-6"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirmation-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="confirmation-modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Hapus</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const mainContent = document.getElementById('main-content');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const closeMenuButton = document.getElementById('close-menu-button');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            // --- FUNGSI NOTIFIKASI ---
            const showNotification = (message, type = 'success') => {
                console.log(`Pemberitahuan (${type}): ${message}`);
            };

            // --- MODAL KONFIRMASI LOGIC ---
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationModalMessage = document.getElementById('confirmation-modal-message');
            const confirmationModalConfirm = document.getElementById('confirmation-modal-confirm');
            const confirmationModalCancel = document.getElementById('confirmation-modal-cancel');

            function showConfirmationModal(message, onConfirm) {
                confirmationModalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                confirmationModal.classList.add('flex');
                
                confirmationModalConfirm.onclick = () => {
                    onConfirm();
                    hideConfirmationModal();
                };
            }

            function hideConfirmationModal() {
                confirmationModal.classList.add('hidden');
                confirmationModal.classList.remove('flex');
                confirmationModalConfirm.onclick = null;
            }

            confirmationModalCancel.onclick = hideConfirmationModal;


            // --- DATA MANAGEMENT ---
            const initialData = {
                kategori: ['Order Kuota', 'DANA', 'Go-Pay', 'Shopee-Pay', 'Kas / Cash', 'Modal', 'Laba Bersih', 'Fee BRI Link', 'I-Simple', 'Digipos', 'Hutang', 'BNI', 'BRI Nussa', 'BRI Galih', 'Pemasukan', 'Pengeluaran', 'Penyesuaian', 'Penjualan ATK', 'Service', 'Tabungan', 'Save Plus', 'Pengeluaran Rumah', 'Transfer', 'Tarik Tunai', 'Setor Tunai', 'APK', 'Kulak (SP/Voucher/dll)'],
                akun: [
                    { name: 'Kas / Cash', balance: 1000000 }, { name: 'BRI Galih', balance: 5000000 }, { name: 'BRI Nussa', balance: 0 }, { name: 'BNI', balance: 0 }, 
                    { name: 'Bank Jateng', balance: 0 }, { name: 'Buku Warung/Agen', balance: 0 }, { name: 'DANA Galih', balance: 0 }, { name: 'DANA Nussa', balance: 0 }, 
                    { name: 'Shopee Pay', balance: 0 }, { name: 'Go-Pay', balance: 0 }, { name: 'Order Kuota', balance: 0 }, { name: 'Digipost', balance: 0 }, 
                    { name: 'Save Plus', balance: 0 }, { name: 'I-Simple', balance: 0 }, { name: 'Tabungan', balance: 0 }, { name: 'Laba Bersih', balance: 0 }, 
                    { name: 'Fee BRI Link', balance: 0 }, { name: 'Hutang Piutang', balance: 0 }, { name: 'Modal', balance: 10000000 }
                ],
                jenisAplikasi: ['Dana', 'Digipos', 'I-Simple', 'Gopay', 'Save Plus', 'Shopee Pay', 'Buku Warung/Agen', 'OVO', 'Order Kuota'],
                pelanggan: ['Pelanggan Umum', 'John Doe', 'Jane Smith'],
                pengguna: ['Admin', 'Kasir 1'],
                produk: [
                    { name: 'Pulsa TSEL 5k', hargaModal: 5500, hargaJual: 7000, stok: 99 },
                    { name: 'Token PLN 20k', hargaModal: 20000, hargaJual: 21500, stok: 50 },
                    { name: 'Voucher Axis AIGO 2GB', hargaModal: 12000, hargaJual: 15000, stok: 25 },
                ],
                transaksi: [],
                transaksiKeuangan: [],
                hutangPiutang: []
            };
            
            let appData = JSON.parse(localStorage.getItem('appData')) || initialData;

            function saveData() {
                localStorage.setItem('appData', JSON.stringify(appData));
                renderSidebarAkunList();
                updateHeaderCards();
                if(document.querySelector('#main-content .space-y-8')){
                    const startDateInput = document.getElementById('filter-tanggal-mulai');
                    const endDateInput = document.getElementById('filter-tanggal-akhir');
                    updateDashboardData(startDateInput.value, endDateInput.value);
                }
            }

            const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { 
                style: 'currency', 
                currency: 'IDR', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);

            function toLocalDateString(date) {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            // --- FUNGSI UTILITY DASHBOARD & LAPORAN ---
            function getTransactionsForDateRange(startDate, endDate) {
                // Tambahkan T00:00:00 untuk menghindari masalah zona waktu saat mem-parsing string tanggal saja
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T23:59:59');
                
                return appData.transaksi.filter(trx => {
                    const trxDate = new Date(trx.date);
                    return trxDate >= start && trxDate <= end;
                });
            }
            
            function calculateTodaysStats() {
                const todayStr = toLocalDateString(new Date());
                const todaysTransactions = getTransactionsForDateRange(todayStr, todayStr);
                
                const totalRevenue = todaysTransactions.reduce((sum, trx) => sum + trx.totalJual, 0);
                const totalProfit = todaysTransactions.reduce((sum, trx) => sum + trx.laba, 0);
                const transactionCount = todaysTransactions.length;
                
                return { totalRevenue, totalProfit, transactionCount };
            }

            function calculateFinancialProfitToday() {
                const todayStr = toLocalDateString(new Date());
                const todaysFinancial = (appData.transaksiKeuangan || []).filter(trx => {
                    const trxDate = new Date(trx.date);
                    return toLocalDateString(trxDate) === todayStr;
                });

                return todaysFinancial.reduce((sum, trx) => {
                    if (trx.toAccount === 'Laba Bersih') {
                        return sum + trx.amount;
                    }
                    return sum;
                }, 0);
            }

            function getAccountColor(accountName) {
                const colors = [
                    'bg-sky-900/50', 'bg-teal-900/50', 'bg-indigo-900/50', 'bg-rose-900/50',
                    'bg-blue-900/50', 'bg-emerald-900/50', 'bg-violet-900/50', 'bg-fuchsia-900/50',
                    'bg-cyan-900/50', 'bg-lime-900/50', 'bg-purple-900/50', 'bg-pink-900/50'
                ];
                let hash = 0;
                for (let i = 0; i < accountName.length; i++) {
                    hash = accountName.charCodeAt(i) + ((hash << 5) - hash);
                }
                const index = Math.abs(hash % colors.length);
                return colors[index];
            }

            // --- FUNGSI RENDER SIDEBAR ---
            function renderSidebarAkunList() {
                const container = document.getElementById('sidebar-akun-list');
                if (!container) return;

                const sidebarAkunToShow = [
                    'BRI Galih', 'BRI Nussa', 'BNI', 'Order Kuota', 'DANA Galih',
                    'DANA Nussa', 'Go-Pay', 'Shopee Pay', 'Save Plus',
                    'I-Simple', 'Digipost', 'Buku Warung/Agen'
                ];

                const filteredAkun = appData.akun.filter(akun => sidebarAkunToShow.includes(akun.name));

                const akunHTML = filteredAkun.map(akun => {
                    const colorClass = getAccountColor(akun.name);
                    return `
                    <div class="${colorClass} p-2 rounded-lg transition-all duration-200 ease-in-out hover:scale-105">
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-medium text-slate-200 truncate" title="${akun.name}">${akun.name}</span>
                            <span class="font-bold text-white tracking-wider">${formatCurrency(akun.balance)}</span>
                        </div>
                    </div>
                `}).join('');
                container.innerHTML = akunHTML || '<p class="text-xs text-slate-400">Tidak ada akun untuk ditampilkan.</p>';
            }

            // --- KONTEN HALAMAN ---
            const pages = {
                dashboard: { 
                    title: 'Dashboard',
                    render: renderDashboardPage 
                },
                kasir: { 
                    title: 'Kasir',
                    render: renderKasirPage 
                },
                transaksi: { 
                    title: 'Transaksi Keuangan',
                    render: renderTransaksiPage
                },
                'hutang-piutang': {
                    title: 'Hutang Piutang',
                    render: renderHutangPiutangPage
                },
                 produk: { 
                    title: 'Produk',
                    content: `
                        <div class="flex flex-col h-full max-h-full overflow-hidden gap-4 animate-fade-in">
                            <div id="produk-container-header"></div>
                            <div id="produk-container-list" class="flex-1 overflow-y-auto"></div>
                            <div id="produk-container-footer"></div>
                        </div>`
                },
                laporan: { 
                    title: 'Laporan',
                    render: renderLaporanPage
                },
                pengaturan: {
                    title: 'Pengaturan',
                    render: renderPengaturanPage
                }
            };

             // --- FUNGSI RENDER HALAMAN PENGATURAN ---
            function renderPengaturanPage() {
                mainContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-8 animate-fade-in">
                        <div class="md:col-span-1">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Menu Pengaturan</h2>
                            <nav id="settings-menu" class="space-y-1">
                                <button data-tab="kategori" class="settings-tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md font-medium text-sm transition-colors">
                                    <i class="fas fa-tags w-5 text-center"></i> Kategori
                                </button>
                                <button data-tab="akun" class="settings-tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md font-medium text-sm transition-colors">
                                    <i class="fas fa-wallet w-5 text-center"></i> Akun
                                </button>
                                <button data-tab="jenis-aplikasi" class="settings-tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md font-medium text-sm transition-colors">
                                    <i class="fas fa-mobile-alt w-5 text-center"></i> Jenis Aplikasi
                                </button>
                                <button data-tab="pelanggan" class="settings-tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md font-medium text-sm transition-colors">
                                    <i class="fas fa-users w-5 text-center"></i> Pelanggan
                                </button>
                                <button data-tab="pengguna" class="settings-tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md font-medium text-sm transition-colors">
                                    <i class="fas fa-user-cog w-5 text-center"></i> Pengguna
                                </button>
                                <button data-tab="cadangkan" class="settings-tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md font-medium text-sm transition-colors">
                                    <i class="fas fa-save w-5 text-center"></i> Cadangkan Data
                                </button>
                            </nav>
                        </div>
                        <div class="md:col-span-3">
                            <div id="tab-kategori" class="settings-tab-panel"></div>
                            <div id="tab-akun" class="settings-tab-panel"></div>
                            <div id="tab-jenis-aplikasi" class="settings-tab-panel"></div>
                            <div id="tab-pelanggan" class="settings-tab-panel"></div>
                            <div id="tab-pengguna" class="settings-tab-panel"></div>
                            <div id="tab-cadangkan" class="settings-tab-panel">
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold mb-2 text-gray-800">Cadangkan & Pulihkan Data</h3>
                                    <p class="text-gray-600 mb-6">Simpan semua data (produk, akun, kategori, dll) ke dalam file, atau pulihkan dari file cadangan.</p>
                                    <div class="flex flex-col sm:flex-row gap-4">
                                        <button id="backup-btn" class="w-full px-5 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center justify-center gap-2 font-semibold transition-colors">
                                            <i class="fas fa-download"></i>Cadangkan Semua Data
                                        </button>
                                        <label class="w-full px-5 py-3 bg-sky-600 text-white rounded-md hover:bg-sky-700 flex items-center justify-center gap-2 font-semibold cursor-pointer transition-colors">
                                            <i class="fas fa-upload"></i>Pulihkan Semua Data
                                            <input type="file" id="restore-input" class="hidden" accept=".json">
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-4">Penting: Memulihkan data akan menimpa semua data yang ada saat ini. Pastikan Anda memilih file cadangan yang benar.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                initializeSettingsTabs();
            }

            // --- FUNGSI-FUNGSI DASHBOARD ---
            function updateHeaderCards() {
                const totalSaldo = appData.akun.reduce((sum, acc) => sum + acc.balance, 0);
                const totalTanpaPiutang = appData.akun.filter(acc => acc.name !== 'Hutang Piutang').reduce((sum, acc) => sum + acc.balance, 0);
                
                const kasAkun = appData.akun.find(a => a.name === 'Kas / Cash')?.balance || 0;
                const tabunganAkun = appData.akun.find(a => a.name === 'Tabungan')?.balance || 0;
                const modalAkun = appData.akun.find(a => a.name === 'Modal')?.balance || 0;
                const labaAkun = appData.akun.find(a => a.name === 'Laba Bersih')?.balance || 0;
                const piutangAkun = appData.akun.find(a => a.name === 'Hutang Piutang')?.balance || 0;
                
                const totalCash = kasAkun + tabunganAkun + modalAkun + labaAkun;

                document.getElementById('total-saldo-value').textContent = formatCurrency(totalSaldo);
                document.getElementById('saldo-tanpa-piutang-value').textContent = formatCurrency(totalTanpaPiutang);
                document.getElementById('total-cash-value').textContent = formatCurrency(totalCash);
                document.getElementById('modal-value').textContent = formatCurrency(modalAkun);
                document.getElementById('laba-bersih-value').textContent = formatCurrency(labaAkun);
                document.getElementById('piutang-value').textContent = formatCurrency(piutangAkun);
            }

            function createDashboardCard(title, value, icon, iconColor, valueClass = 'text-xl') {
                return `
                    <h4 class="text-sm font-medium text-gray-500 truncate">${title}</h4>
                    <div class="flex items-center justify-between mt-2">
                        <p class="${valueClass} font-bold text-gray-800 truncate">${value}</p>
                        <i class="fas ${icon} ${iconColor} text-2xl"></i>
                    </div>
                `;
            }

            function updateDashboardData(startDateStr, endDateStr) {
                // Filter data based on date range
                let filteredKeuangan = appData.transaksiKeuangan || [];
                let filteredTransaksi = appData.transaksi || [];

                if (startDateStr && endDateStr) {
                    const start = new Date(startDateStr + 'T00:00:00');
                    const end = new Date(endDateStr + 'T23:59:59');

                    filteredKeuangan = filteredKeuangan.filter(t => {
                        const trxDate = new Date(t.date);
                        return trxDate >= start && trxDate <= end;
                    });
                    filteredTransaksi = filteredTransaksi.filter(t => {
                        const trxDate = new Date(t.date);
                        return trxDate >= start && trxDate <= end;
                    });
                }

                // ANALISA UMUM
                const totalPemasukan = filteredKeuangan.filter(t => t.type === 'Pendapatan').reduce((sum, t) => sum + t.amount, 0);
                const totalPengeluaran = filteredKeuangan.filter(t => t.type === 'Pengeluaran').reduce((sum, t) => sum + t.amount, 0);
                
                const feeBriLinkAkun = appData.akun.find(a => a.name === 'Fee BRI Link')?.balance || 0;
                
                const briNussaAkun = appData.akun.find(a => a.name === 'BRI Nussa')?.balance || 0;
                const briNussaDikurangiFee = briNussaAkun - feeBriLinkAkun;

                const produkTerjual = filteredTransaksi.filter(t => t.type === 'Produk').reduce((sum, t) => sum + t.items.reduce((itemSum, item) => itemSum + item.qty, 0), 0);
                const transaksiJasa = filteredTransaksi.filter(t => t.type === 'Jasa' || t.type === 'Aplikasi').length;

                document.getElementById('card-pemasukan').innerHTML = createDashboardCard('Total Pemasukan', formatCurrency(totalPemasukan), 'fa-arrow-down', 'text-green-500');
                document.getElementById('card-pengeluaran').innerHTML = createDashboardCard('Total Pengeluaran', formatCurrency(totalPengeluaran), 'fa-arrow-up', 'text-red-500');
                document.getElementById('card-fee-bri').innerHTML = createDashboardCard('Fee BRI Link', formatCurrency(feeBriLinkAkun), 'fa-link', 'text-blue-500');
                document.getElementById('card-bri-nussa-fee').innerHTML = createDashboardCard('BRI Nussa - Fee', formatCurrency(briNussaDikurangiFee), 'fa-balance-scale', 'text-indigo-500');
                document.getElementById('card-produk-terjual').innerHTML = createDashboardCard('Produk Terjual', produkTerjual, 'fa-box', 'text-yellow-500');
                document.getElementById('card-transaksi-jasa').innerHTML = createDashboardCard('Transaksi Jasa', transaksiJasa, 'fa-hand-sparkles', 'text-purple-500');

                // KEUANGAN PRIBADI
                const tabungan = appData.akun.find(a => a.name === 'Tabungan')?.balance || 0; // Unaffected by filter
                
                // Laba dari penjualan (kasir)
                const labaDariPenjualan = filteredTransaksi.reduce((sum, t) => sum + t.laba, 0);
                
                // Laba dari transaksi keuangan lainnya (berdasarkan kategori 'Laba Bersih')
                const labaDariKeuangan = filteredKeuangan
                    .filter(t => t.category === 'Laba Bersih' && t.type === 'Pendapatan')
                    .reduce((sum, t) => sum + t.amount, 0);

                const labaBersihTotalPeriode = labaDariPenjualan + labaDariKeuangan;

                const pengeluaranRumahPeriode = filteredKeuangan.filter(t => t.category === 'Pengeluaran Rumah').reduce((sum, t) => sum + t.amount, 0);

                document.getElementById('card-tabungan').innerHTML = createDashboardCard('Saldo Tabungan', formatCurrency(tabungan), 'fa-piggy-bank', 'text-pink-500', 'text-2xl');
                document.getElementById('card-laba-harian').innerHTML = createDashboardCard('Laba Bersih (Periode)', formatCurrency(labaBersihTotalPeriode), 'fa-sun', 'text-green-500', 'text-2xl');
                document.getElementById('card-pengeluaran-rumah').innerHTML = createDashboardCard('Pengeluaran Rumah (Periode)', formatCurrency(pengeluaranRumahPeriode), 'fa-home', 'text-red-500', 'text-2xl');
                
                // DIAGRAM
                renderCharts(totalPemasukan, totalPengeluaran, filteredTransaksi, labaBersihTotalPeriode, pengeluaranRumahPeriode);

                // INFO TERKINI
                renderLast10Transactions(filteredTransaksi);
                renderBestSellingProducts(filteredTransaksi);
                renderActiveDebts(); // Unaffected by filter
            }
            
            function renderCharts(totalPemasukan, totalPengeluaran, allFilteredTransactions, labaBersihTotalPeriode, pengeluaranRumahPeriode) {
                // Hancurkan chart yang ada jika sudah ada untuk mencegah duplikat
                if(window.incomeExpenseChart instanceof Chart) {
                    window.incomeExpenseChart.destroy();
                }
                if(window.salesChart instanceof Chart) {
                    window.salesChart.destroy();
                }
                 if(window.appSalesChart instanceof Chart) {
                    window.appSalesChart.destroy();
                }

                // Chart 1: Laba Bersih vs Pengeluaran Rumah
                const incomeCtx = document.getElementById('incomeVsExpenseChart').getContext('2d');
                window.incomeExpenseChart = new Chart(incomeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Laba Bersih', 'Pengeluaran Rumah'],
                        datasets: [{
                            data: [labaBersihTotalPeriode, pengeluaranRumahPeriode],
                            backgroundColor: ['#22c55e', '#f97316'], // Green-500, Orange-500
                            borderColor: '#f1f5f9', // slate-100 for a subtle border
                            borderWidth: 4,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 14
                                    },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: '#111827',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 10,
                                cornerRadius: 5,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Chart 2: Grafik Penjualan Produk
                const salesCtx = document.getElementById('salesChart').getContext('2d');
                const productSalesTransactions = allFilteredTransactions.filter(t => t.type === 'Produk');
                const salesByDay = {};
                productSalesTransactions.forEach(t => {
                    const dateStr = toLocalDateString(new Date(t.date));
                    salesByDay[dateStr] = (salesByDay[dateStr] || 0) + t.totalJual;
                });
                
                const labels = Object.keys(salesByDay).sort((a,b) => new Date(a) - new Date(b));
                const salesData = labels.map(label => salesByDay[label]);

                window.salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: labels.map(l => new Date(l+'T00:00:00').toLocaleDateString('id-ID', {day: 'numeric', month: 'short'})),
                        datasets: [{
                            label: 'Penjualan',
                            data: salesData,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000) return 'Rp ' + (value / 1000) + 'k';
                                        return 'Rp ' + value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                // Chart 3: Grafik Penjualan Aplikasi
                const appSalesTransactions = allFilteredTransactions.filter(t => t.type === 'Aplikasi');
                const appSalesByType = {};
                appSalesTransactions.forEach(t => {
                    const appType = t.detail;
                    appSalesByType[appType] = (appSalesByType[appType] || 0) + t.totalJual;
                });

                const appLabels = Object.keys(appSalesByType);
                const appData = Object.values(appSalesByType);

                const appCtx = document.getElementById('appSalesChart').getContext('2d');
                
                const gradient = appCtx.createLinearGradient(0, 0, 0, 320);
                gradient.addColorStop(0, 'rgba(14, 165, 233, 0.8)');
                gradient.addColorStop(1, 'rgba(56, 189, 248, 0.2)');

                window.appSalesChart = new Chart(appCtx, {
                    type: 'bar',
                    data: {
                        labels: appLabels,
                        datasets: [{
                            label: 'Penjualan Aplikasi',
                            data: appData,
                            backgroundColor: gradient,
                            borderColor: 'rgba(14, 165, 233, 1)',
                            borderWidth: 2,
                            borderRadius: 5,
                            hoverBackgroundColor: 'rgba(14, 165, 233, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { display: false },
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000) return 'Rp ' + (value / 1000) + 'k';
                                        return 'Rp ' + value;
                                    }
                                }
                            },
                            x: {
                               grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#111827',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 12 },
                                padding: 10,
                                cornerRadius: 5,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return 'Total: ' + formatCurrency(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
            }


            function renderLast10Transactions(filteredTransaksi) {
                const container = document.getElementById('list-transaksi-terakhir');
                const last10 = filteredTransaksi.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
                if(last10.length === 0){
                    container.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">Belum ada transaksi pada periode ini.</p>`;
                    return;
                }
                container.innerHTML = last10.map(trx => `
                    <div class="flex justify-between items-center text-sm border-b pb-2 last:border-0 last:pb-0">
                        <div>
                            <p class="font-semibold text-gray-700">${trx.detail}</p>
                            <p class="text-xs text-gray-400">${new Date(trx.date).toLocaleString('id-ID')}</p>
                        </div>
                        <p class="font-bold text-gray-800">${formatCurrency(trx.totalJual)}</p>
                    </div>
                `).join('');
            }

            function renderBestSellingProducts(filteredTransaksi) {
                const container = document.getElementById('list-produk-terlaris');
                const salesCount = {};
                filteredTransaksi.filter(t => t.type === 'Produk').forEach(t => {
                    t.items.forEach(item => {
                        salesCount[item.name] = (salesCount[item.name] || 0) + item.qty;
                    });
                });

                const sortedProducts = Object.entries(salesCount).sort((a,b) => b[1] - a[1]).slice(0, 10);
                
                if(sortedProducts.length === 0){
                    container.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">Belum ada produk terjual pada periode ini.</p>`;
                    return;
                }

                container.innerHTML = sortedProducts.map(([name, qty]) => `
                     <div class="flex justify-between items-center text-sm border-b pb-2 last:border-0 last:pb-0">
                        <p class="font-semibold text-gray-700">${name}</p>
                        <p class="font-bold text-gray-800">${qty} terjual</p>
                    </div>
                `).join('');
            }

            function renderActiveDebts() {
                const container = document.getElementById('list-piutang-aktif');
                const activeDebts = (appData.hutangPiutang || []).filter(h => h.status === 'Belum Lunas').sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
                
                if(activeDebts.length === 0){
                    container.innerHTML = `<p class="text-sm text-gray-500 text-center py-4">Tidak ada piutang aktif.</p>`;
                    return;
                }

                container.innerHTML = activeDebts.map(debt => `
                    <div class="flex justify-between items-center text-sm border-b pb-2 last:border-0 last:pb-0">
                        <div>
                            <p class="font-semibold text-gray-700">${debt.nama}</p>
                            <p class="text-xs text-gray-400">${new Date(debt.date).toLocaleDateString('id-ID')}</p>
                        </div>
                        <p class="font-bold text-red-600">${formatCurrency(debt.jumlah)}</p>
                    </div>
                `).join('');
            }

            function setupDashboardFilters() {
                const startDateInput = document.getElementById('filter-tanggal-mulai');
                const endDateInput = document.getElementById('filter-tanggal-akhir');
                const filterButtons = document.querySelectorAll('.filter-btn');

                function applyFilter() {
                    updateDashboardData(startDateInput.value, endDateInput.value);
                }

                function setActiveButton(activeBtn) {
                    filterButtons.forEach(btn => {
                        btn.classList.remove('bg-sky-600', 'text-white');
                        btn.classList.add('bg-sky-100', 'text-sky-700');
                    });
                    if (activeBtn) {
                        activeBtn.classList.add('bg-sky-600', 'text-white');
                        activeBtn.classList.remove('bg-sky-100', 'text-sky-700');
                    }
                }

                startDateInput.addEventListener('change', () => {
                    setActiveButton(null); 
                    applyFilter();
                });
                endDateInput.addEventListener('change', () => {
                    setActiveButton(null);
                    applyFilter();
                });

                document.getElementById('filter-reset').addEventListener('click', () => {
                    startDateInput.value = '';
                    endDateInput.value = '';
                    setActiveButton(null);
                    updateDashboardData(); // Call without params to show all data
                });

                filterButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const range = btn.dataset.range;
                        const today = new Date();
                        let startDate = new Date();

                        if (range === 'today') {
                            startDate = today;
                        } else if (range === 'week') {
                            startDate.setDate(today.getDate() - 6);
                        } else if (range === 'month') {
                            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        }
                        
                        startDateInput.value = toLocalDateString(startDate);
                        endDateInput.value = toLocalDateString(today);
                        setActiveButton(btn);
                        applyFilter();
                    });
                });

                // Set default filter to "Bulan Ini" on initial load
                document.querySelector('.filter-btn[data-range="month"]').click();
            }

            function renderDashboardPage() {
                mainContent.innerHTML = `
                    <div class="space-y-8 animate-fade-in">
                        <!-- Filter Section -->
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div class="flex flex-wrap items-center gap-x-6 gap-y-3">
                                <h3 class="text-lg font-semibold text-gray-700 flex-shrink-0">Filter Periode:</h3>
                                <div class="flex items-center gap-2">
                                    <label for="filter-tanggal-mulai" class="text-sm font-medium text-gray-600">Mulai</label>
                                    <input type="date" id="filter-tanggal-mulai" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <div class="flex items-center gap-2">
                                    <label for="filter-tanggal-akhir" class="text-sm font-medium text-gray-600">Akhir</label>
                                    <input type="date" id="filter-tanggal-akhir" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <div class="flex items-center space-x-2">
                                     <button data-range="today" class="filter-btn px-3 py-1.5 text-sm font-semibold rounded-md transition-colors bg-sky-100 text-sky-700 hover:bg-sky-200">Hari Ini</button>
                                     <button data-range="week" class="filter-btn px-3 py-1.5 text-sm font-semibold rounded-md transition-colors bg-sky-100 text-sky-700 hover:bg-sky-200">7 Hari</button>
                                     <button data-range="month" class="filter-btn px-3 py-1.5 text-sm font-semibold rounded-md transition-colors bg-sky-100 text-sky-700 hover:bg-sky-200">Bulan Ini</button>
                                     <button id="filter-reset" class="px-3 py-1.5 text-sm font-semibold rounded-md bg-gray-200 hover:bg-gray-300 transition-colors" title="Reset semua filter">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bagian 1: Analisa Umum -->
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Analisa Umum (Periode Dipilih)</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div id="card-pemasukan" class="bg-white p-4 rounded-lg shadow-md"></div>
                                <div id="card-pengeluaran" class="bg-white p-4 rounded-lg shadow-md"></div>
                                <div id="card-fee-bri" class="bg-white p-4 rounded-lg shadow-md"></div>
                                <div id="card-bri-nussa-fee" class="bg-white p-4 rounded-lg shadow-md"></div>
                                <div id="card-produk-terjual" class="bg-white p-4 rounded-lg shadow-md"></div>
                                <div id="card-transaksi-jasa" class="bg-white p-4 rounded-lg shadow-md"></div>
                            </div>
                        </div>

                        <!-- Bagian 2: Keuangan Pribadi -->
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Keuangan Pribadi</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div id="card-tabungan" class="bg-white p-4 rounded-lg shadow-md"></div>
                                <div id="card-laba-harian" class="bg-white p-4 rounded-lg shadow-md"></div>
                                <div id="card-pengeluaran-rumah" class="bg-white p-4 rounded-lg shadow-md"></div>
                            </div>
                        </div>

                        <!-- Bagian 3: Diagram -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                                <h3 class="text-lg font-semibold mb-4">Laba Bersih vs Pengeluaran Rumah</h3>
                                <div class="relative h-80">
                                    <canvas id="incomeVsExpenseChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                                <h3 class="text-lg font-semibold mb-4">Grafik Penjualan Produk</h3>
                                <div class="relative h-80">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                                <h3 class="text-lg font-semibold mb-4">Grafik Penjualan Aplikasi</h3>
                                <div class="relative h-80">
                                    <canvas id="appSalesChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Bagian 4: Info Terkini -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="bg-white p-4 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-4">Transaksi Terakhir (Periode Dipilih)</h3>
                                <div id="list-transaksi-terakhir" class="space-y-3 max-h-96 overflow-y-auto"></div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-4">Produk Terlaris (Periode Dipilih)</h3>
                                <div id="list-produk-terlaris" class="space-y-3 max-h-96 overflow-y-auto"></div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-4">10 Piutang Aktif Teratas</h3>
                                <div id="list-piutang-aktif" class="space-y-3 max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                `;
                setupDashboardFilters();
            }

            // --- FUNGSI RENDER HALAMAN HUTANG PIUTANG ---
            function renderHutangPiutangPage() {
                mainContent.innerHTML = `
                    <div class="flex flex-col h-full max-h-full overflow-hidden gap-6">
                        <div class="bg-white rounded-lg shadow-md p-4">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                <h2 class="text-xl font-bold text-gray-800">Manajemen Hutang</h2>
                                <button id="tambah-hutang-btn" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 text-sm font-semibold flex items-center w-full sm:w-auto">
                                    <i class="fas fa-plus mr-2"></i>Tambah Hutang
                                </button>
                            </div>
                            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3 items-center">
                                <div class="relative xl:col-span-2">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="search" id="hutang-filter-search" placeholder="Cari nama atau catatan..." class="w-full pl-10 pr-4 py-2 border rounded-md text-sm bg-slate-50 focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <select id="hutang-filter-status" class="w-full p-2 border rounded-md text-sm bg-slate-50 focus:ring-sky-500 focus:border-sky-500">
                                    <option value="Semua">Semua Status</option>
                                    <option value="Belum Lunas">Belum Lunas</option>
                                    <option value="Lunas">Lunas</option>
                                </select>
                                <div class="flex items-center gap-2">
                                    <input type="date" id="hutang-filter-tanggal" class="w-full p-2 border rounded-md text-sm bg-slate-50 focus:ring-sky-500 focus:border-sky-500" title="Filter berdasarkan tanggal">
                                    <button id="hutang-filter-reset" class="px-3 py-2 border rounded-md text-sm hover:bg-slate-100 transition-colors" title="Reset semua filter">
                                        <i class="fas fa-undo text-gray-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="hutang-list-container" class="flex-1 overflow-y-auto">
                            <!-- Daftar hutang akan dirender di sini -->
                        </div>

                        <div class="mt-auto pt-4">
                             <div class="bg-rose-100 p-4 rounded-lg shadow">
                                <h4 class="text-sm font-medium text-rose-800">Total Hutang (Belum Lunas)</h4>
                                <p id="total-hutang-aktif" class="text-2xl font-bold text-rose-900">0</p>
                            </div>
                        </div>
                    </div>
                `;
                renderHutangPiutangList();
                document.getElementById('tambah-hutang-btn').addEventListener('click', () => showHutangPiutangModal());
                
                // Add event listeners for new filters
                document.getElementById('hutang-filter-search').addEventListener('input', renderHutangPiutangList);
                document.getElementById('hutang-filter-status').addEventListener('change', renderHutangPiutangList);
                document.getElementById('hutang-filter-tanggal').addEventListener('change', renderHutangPiutangList);
                document.getElementById('hutang-filter-reset').addEventListener('click', () => {
                    document.getElementById('hutang-filter-search').value = '';
                    document.getElementById('hutang-filter-status').value = 'Semua';
                    document.getElementById('hutang-filter-tanggal').value = '';
                    renderHutangPiutangList();
                });
            }

            function renderHutangPiutangList() {
                const container = document.getElementById('hutang-list-container');
                if (!container) return;

                // 1. Get filter values
                const searchTerm = document.getElementById('hutang-filter-search')?.value.toLowerCase() || '';
                const filterStatus = document.getElementById('hutang-filter-status')?.value || 'Semua';
                const filterTanggal = document.getElementById('hutang-filter-tanggal')?.value || '';

                // Calculate total active debt from the UNFILTERED list to show a consistent total
                const totalHutangAktif = (appData.hutangPiutang || []).reduce((sum, hutang) => {
                    return hutang.status === 'Belum Lunas' ? sum + hutang.jumlah : sum;
                }, 0);
                document.getElementById('total-hutang-aktif').textContent = formatCurrency(totalHutangAktif);

                // 2. Pre-filter by search and date
                const preFiltered = (appData.hutangPiutang || []).filter(hutang => {
                    const searchMatch = !searchTerm || hutang.nama.toLowerCase().includes(searchTerm) || (hutang.catatan && hutang.catatan.toLowerCase().includes(searchTerm));
                    const tanggalMatch = !filterTanggal || toLocalDateString(new Date(hutang.date)) === filterTanggal;
                    return searchMatch && tanggalMatch;
                });

                const belumLunasItems = preFiltered.filter(h => h.status === 'Belum Lunas');
                const lunasItems = preFiltered.filter(h => h.status === 'Lunas');
                
                // Helper function to render a list of items (either Lunas or Belum Lunas)
                const renderTableRows = (items) => {
                    if (items.length === 0) {
                        return `<tr><td colspan="7" class="text-center p-6 text-gray-500">Tidak ada data untuk ditampilkan.</td></tr>`;
                    }

                    const sorted = items.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    return sorted.map(hutang => {
                        const isLunas = hutang.status === 'Lunas';
                        const statusLabel = `<span class="px-2 py-1 rounded-full text-xs font-bold ${
                            isLunas ? 'bg-teal-100 text-teal-800' : 'bg-red-100 text-red-800'
                        }">${hutang.status}</span>`;
                        
                        return `
                            <tr class="border-b last:border-b-0">
                                <td class="p-3 text-sm text-gray-700 font-semibold">${hutang.nama}</td>
                                <td class="p-3 text-sm">${statusLabel}</td>
                                <td class="p-3 text-sm text-gray-600">${new Date(hutang.date).toLocaleDateString('id-ID')}</td>
                                <td class="p-3 text-sm text-gray-600">${hutang.sumberAkun}</td>
                                <td class="p-3 text-sm text-right font-medium text-gray-800">${formatCurrency(hutang.jumlah)}</td>
                                <td class="p-3 text-sm text-gray-500 max-w-xs truncate" title="${hutang.catatan || ''}">${hutang.catatan || '-'}</td>
                                <td class="p-3 text-sm">
                                    <div class="flex items-center justify-end gap-3">
                                        ${!isLunas ? `<button class="lunas-btn text-green-500 hover:text-green-700" data-id="${hutang.id}" title="Tandai Lunas"><i class="fas fa-check-circle"></i></button>` : ''}
                                        <button class="edit-hutang-btn text-sky-500 hover:text-sky-700" data-id="${hutang.id}" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="hapus-hutang-btn text-red-500 hover:text-red-700" data-id="${hutang.id}" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                };

                const tableHeader = `
                    <thead class="bg-slate-100">
                        <tr class="border-b-2 border-slate-200">
                            <th class="w-2/12 p-3 text-sm font-semibold tracking-wide text-left">Penghutang</th>
                            <th class="w-1/12 p-3 text-sm font-semibold tracking-wide text-left">Status</th>
                            <th class="w-1/12 p-3 text-sm font-semibold tracking-wide text-left">Tanggal</th>
                            <th class="w-2/12 p-3 text-sm font-semibold tracking-wide text-left">Sumber Akun</th>
                            <th class="w-1/12 p-3 text-sm font-semibold tracking-wide text-right">Tagihan</th>
                            <th class="w-3/12 p-3 text-sm font-semibold tracking-wide text-left">Catatan</th>
                            <th class="w-1/12 p-3 text-sm font-semibold tracking-wide text-right">Aksi</th>
                        </tr>
                    </thead>`;
                
                let finalHTML = '';

                // 3. Render "Belum Lunas" section
                if (filterStatus === 'Semua' || filterStatus === 'Belum Lunas') {
                    finalHTML += `
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-red-800 mb-4">Hutang Aktif (Belum Lunas)</h3>
                            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                                <table class="w-full">
                                    ${tableHeader}
                                    <tbody class="divide-y divide-slate-100">${renderTableRows(belumLunasItems)}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }

                // 4. Render "Lunas" section (collapsible)
                if (filterStatus === 'Semua' || filterStatus === 'Lunas') {
                    finalHTML += `
                        <div class="mb-8">
                             <button id="toggle-lunas-history" class="w-full flex justify-between items-center text-left p-4 bg-white rounded-lg shadow-md mb-2 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all">
                                <h3 class="text-xl font-bold text-green-800">Riwayat Hutang Lunas</h3>
                                <i id="toggle-lunas-icon" class="fas fa-chevron-down transition-transform"></i>
                            </button>
                            <div id="lunas-history-container" class="hidden">
                                <div class="overflow-x-auto bg-white rounded-lg shadow-md animate-fade-in">
                                    <table class="w-full">
                                        ${tableHeader}
                                        <tbody class="divide-y divide-slate-100">${renderTableRows(lunasItems)}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                }


                // 5. Handle empty state and update DOM
                if (finalHTML.trim() === '') {
                    container.innerHTML = '<div class="text-center py-10"><p class="text-gray-500">Tidak ada data hutang yang cocok dengan filter.</p></div>';
                } else {
                    container.innerHTML = finalHTML;
                }
            }


            // --- FUNGSI RENDER HALAMAN LAPORAN ---
            function renderLaporanPage() {
                mainContent.innerHTML = `
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-md animate-fade-in">
                    <div id="laporan-container">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                <button data-tab="penjualan" class="laporan-tab-button whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm">Laporan Penjualan</button>
                                <button data-tab="perbankan" class="laporan-tab-button whitespace-nowrap py-4 px-1 border-b-2 font-semibold text-sm">Laporan Transaksi Bank</button>
                            </nav>
                        </div>

                        <div class="mt-6">
                            <div id="laporan-filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end mb-6">
                                <div>
                                    <label for="laporan-tanggal-mulai" class="block text-sm font-medium text-gray-700">Tanggal Mulai</label>
                                    <input type="date" id="laporan-tanggal-mulai" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                                <div>
                                    <label for="laporan-tanggal-akhir" class="block text-sm font-medium text-gray-700">Tanggal Akhir</label>
                                    <input type="date" id="laporan-tanggal-akhir" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                                <div id="laporan-filter-tambahan"></div>
                                <div class="flex items-center gap-2">
                                     <button id="laporan-reset-btn" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 flex items-center justify-center"><i class="fas fa-undo mr-2"></i>Reset</button>
                                    <button id="laporan-print-btn" class="w-full px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 flex items-center justify-center"><i class="fas fa-print mr-2"></i>Cetak</button>
                                </div>
                            </div>
                            <div id="laporan-content">
                                <div id="tab-penjualan" class="laporan-tab-panel"></div>
                                <div id="tab-perbankan" class="laporan-tab-panel"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
                initializeLaporanTabs();
            }

            function initializeLaporanTabs() {
                const tabButtons = document.querySelectorAll('.laporan-tab-button');
                const tabPanels = document.querySelectorAll('.laporan-tab-panel');
                const filterTambahanContainer = document.getElementById('laporan-filter-tambahan');
                
                document.getElementById('laporan-tanggal-mulai').value = toLocalDateString(new Date());
                document.getElementById('laporan-tanggal-akhir').value = toLocalDateString(new Date());

                function setActiveTab(activeButton) {
                    const tabId = activeButton.dataset.tab;

                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-sky-500', 'text-sky-600');
                        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    activeButton.classList.add('border-sky-500', 'text-sky-600');
                    
                    tabPanels.forEach(panel => panel.classList.add('hidden'));
                    document.getElementById('tab-' + tabId).classList.remove('hidden');

                    // Set filter tambahan
                    if (tabId === 'penjualan') {
                        filterTambahanContainer.innerHTML = `
                            <label for="laporan-jenis-penjualan" class="block text-sm font-medium text-gray-700">Jenis Penjualan</label>
                            <select id="laporan-jenis-penjualan" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="Semua">Semua</option>
                                <option value="Produk">Produk</option>
                                <option value="Jasa">Jasa</option>
                                <option value="Aplikasi">Aplikasi</option>
                            </select>`;
                    } else if (tabId === 'perbankan') {
                        const akunOptions = appData.akun.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
                        filterTambahanContainer.innerHTML = `
                            <label for="laporan-akun-bank" class="block text-sm font-medium text-gray-700">Pilih Akun</label>
                            <select id="laporan-akun-bank" class="mt-1 w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="Semua">Semua Akun</option>
                                ${akunOptions}
                            </select>`;
                    }
                    renderActiveLaporanTab();
                }
                
                tabButtons.forEach(button => button.addEventListener('click', () => setActiveTab(button)));
                document.getElementById('laporan-filters').addEventListener('change', renderActiveLaporanTab);
                document.getElementById('laporan-print-btn').addEventListener('click', handlePrintLaporan);
                document.getElementById('laporan-reset-btn').addEventListener('click', () => {
                    document.getElementById('laporan-tanggal-mulai').value = toLocalDateString(new Date());
                    document.getElementById('laporan-tanggal-akhir').value = toLocalDateString(new Date());
                    const tambahanFilter = document.querySelector('#laporan-filter-tambahan select');
                    if (tambahanFilter) {
                        tambahanFilter.selectedIndex = 0;
                    }
                    renderActiveLaporanTab();
                });

                setActiveTab(tabButtons[0]);
            }
            
            function renderActiveLaporanTab() {
                const activeTab = document.querySelector('.laporan-tab-button.border-sky-500').dataset.tab;
                if (activeTab === 'penjualan') {
                    renderLaporanPenjualan();
                } else if (activeTab === 'perbankan') {
                    renderLaporanPerbankan();
                }
            }

            function renderLaporanPenjualan() {
                const container = document.getElementById('tab-penjualan');
                const startDate = document.getElementById('laporan-tanggal-mulai').value;
                const endDate = document.getElementById('laporan-tanggal-akhir').value;
                const jenis = document.getElementById('laporan-jenis-penjualan').value;

                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T23:59:59');

                const filteredData = appData.transaksi.filter(trx => {
                    const trxDate = new Date(trx.date);
                    const jenisMatch = jenis === 'Semua' || trx.type === jenis;
                    return trxDate >= start && trxDate <= end && jenisMatch;
                });
                
                const totalModal = filteredData.reduce((sum, trx) => sum + trx.totalModal, 0);
                const totalJual = filteredData.reduce((sum, trx) => sum + trx.totalJual, 0);
                const totalLaba = filteredData.reduce((sum, trx) => sum + trx.laba, 0);

                const tableRows = filteredData.map(trx => `
                    <tr class="border-b">
                        <td class="p-2 text-sm">${new Date(trx.date).toLocaleString('id-ID')}</td>
                        <td class="p-2 text-sm">${trx.detail}</td>
                        <td class="p-2 text-sm">${trx.type}</td>
                        <td class="p-2 text-sm text-right">${formatCurrency(trx.totalModal)}</td>
                        <td class="p-2 text-sm text-right">${formatCurrency(trx.totalJual)}</td>
                        <td class="p-2 text-sm text-right font-semibold">${formatCurrency(trx.laba)}</td>
                    </tr>
                `).join('');

                container.innerHTML = `
                    <div id="print-area">
                        <h3 class="text-lg font-bold mb-2">Laporan Penjualan</h3>
                        <p class="text-sm mb-4">Periode: ${startDate} s/d ${endDate}</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-red-100 p-3 rounded-lg"><h4 class="text-sm font-medium">Total Modal</h4><p class="font-bold text-lg">${formatCurrency(totalModal)}</p></div>
                            <div class="bg-blue-100 p-3 rounded-lg"><h4 class="text-sm font-medium">Total Penjualan</h4><p class="font-bold text-lg">${formatCurrency(totalJual)}</p></div>
                            <div class="bg-green-100 p-3 rounded-lg"><h4 class="text-sm font-medium">Total Laba</h4><p class="font-bold text-lg">${formatCurrency(totalLaba)}</p></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr class="border-b">
                                        <th class="p-2 text-sm font-semibold text-left">Waktu</th>
                                        <th class="p-2 text-sm font-semibold text-left">Detail</th>
                                        <th class="p-2 text-sm font-semibold text-left">Jenis</th>
                                        <th class="p-2 text-sm font-semibold text-right">Modal</th>
                                        <th class="p-2 text-sm font-semibold text-right">Jual</th>
                                        <th class="p-2 text-sm font-semibold text-right">Laba</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows || `<tr><td colspan="6" class="text-center p-4">Tidak ada data.</td></tr>`}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            function renderLaporanPerbankan() {
                const container = document.getElementById('tab-perbankan');
                const startDate = document.getElementById('laporan-tanggal-mulai').value;
                const endDate = document.getElementById('laporan-tanggal-akhir').value;
                const akun = document.getElementById('laporan-akun-bank').value;
                
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T23:59:59');

                const filteredData = (appData.transaksiKeuangan || []).filter(trx => {
                    const trxDate = new Date(trx.date);
                    const akunMatch = akun === 'Semua' || trx.fromAccount === akun || trx.toAccount === akun;
                    return trxDate >= start && trxDate <= end && akunMatch;
                });
                
                let totalMasuk = 0;
                let totalKeluar = 0;

                const tableRows = filteredData.map(trx => {
                    const isMasuk = trx.toAccount === akun || (akun === 'Semua' && trx.type === 'Pendapatan');
                    const isKeluar = trx.fromAccount === akun || (akun === 'Semua' && trx.type === 'Pengeluaran');

                    if(isMasuk) totalMasuk += trx.amount;
                    if(isKeluar) totalKeluar += trx.amount;

                    // Untuk transfer, jika 'Semua Akun' dipilih, kita perlu menampilkannya dengan benar
                    if (akun === 'Semua' && trx.type === 'Transfer') {
                         return `
                            <tr class="border-b">
                                <td class="p-2 text-sm">${new Date(trx.date).toLocaleString('id-ID')}</td>
                                <td class="p-2 text-sm">${trx.category} (${trx.fromAccount} -> ${trx.toAccount})</td>
                                <td class="p-2 text-sm">${trx.notes || '-'}</td>
                                <td class="p-2 text-sm text-right text-gray-500" colspan="2">${formatCurrency(trx.amount)}</td>
                            </tr>
                        `;
                    }
                    
                    return `
                        <tr class="border-b">
                            <td class="p-2 text-sm">${new Date(trx.date).toLocaleString('id-ID')}</td>
                            <td class="p-2 text-sm">${trx.category}</td>
                            <td class="p-2 text-sm">${trx.notes || '-'}</td>
                            <td class="p-2 text-sm text-right text-green-600">${isMasuk ? formatCurrency(trx.amount) : '-'}</td>
                            <td class="p-2 text-sm text-right text-red-600">${isKeluar ? formatCurrency(trx.amount) : '-'}</td>
                        </tr>
                    `;
                }).join('');

                container.innerHTML = `
                    <div id="print-area">
                        <h3 class="text-lg font-bold mb-2">Laporan Transaksi Akun: ${akun}</h3>
                        <p class="text-sm mb-4">Periode: ${startDate} s/d ${endDate}</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-green-100 p-3 rounded-lg"><h4 class="text-sm font-medium">Total Masuk</h4><p class="font-bold text-lg">${formatCurrency(totalMasuk)}</p></div>
                            <div class="bg-red-100 p-3 rounded-lg"><h4 class="text-sm font-medium">Total Keluar</h4><p class="font-bold text-lg">${formatCurrency(totalKeluar)}</p></div>
                             <div class="bg-sky-100 p-3 rounded-lg"><h4 class="text-sm font-medium">Perubahan Bersih</h4><p class="font-bold text-lg">${formatCurrency(totalMasuk - totalKeluar)}</p></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100">
                                    <tr class="border-b">
                                        <th class="p-2 text-sm font-semibold text-left">Waktu</th>
                                        <th class="p-2 text-sm font-semibold text-left">Kategori/Detail</th>
                                        <th class="p-2 text-sm font-semibold text-left">Catatan</th>
                                        <th class="p-2 text-sm font-semibold text-right">Masuk</th>
                                        <th class="p-2 text-sm font-semibold text-right">Keluar</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows || `<tr><td colspan="5" class="text-center p-4">Tidak ada data.</td></tr>`}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            function handlePrintLaporan() {
                const printContents = document.querySelector('#laporan-content .laporan-tab-panel:not(.hidden) #print-area').innerHTML;
                const originalContents = document.body.innerHTML;
                const printWindow = window.open('', '', 'height=800,width=800');
                
                printWindow.document.write('<html><head><title>Cetak Laporan</title>');
                printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
                 printWindow.document.write('<style>body { font-family: "Inter", sans-serif; -webkit-print-color-adjust: exact; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; } th { background-color: #f2f2f2; } h3 {font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;} p {font-size: 0.875rem; margin-bottom: 1rem;} </style>');
                printWindow.document.write('</head><body class="p-6">');
                printWindow.document.write(printContents);
                printWindow.document.write('</body></html>');
                
                printWindow.document.close();
                printWindow.focus(); 
                setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
            }

            // --- FUNGSI RENDER HALAMAN TRANSAKSI KEUANGAN ---
            function renderTransaksiPage() {
                 mainContent.innerHTML = `
                    <div class="flex flex-col h-full max-h-full overflow-hidden gap-6">
                        <div class="bg-white rounded-lg shadow-md p-4">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                <h2 class="text-xl font-bold text-gray-800">Riwayat Transaksi Keuangan</h2>
                                <button id="tambah-transaksi-keuangan-btn" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 text-sm font-semibold flex items-center w-full sm:w-auto">
                                    <i class="fas fa-plus mr-2"></i>Tambah Transaksi
                                </button>
                            </div>
                             <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3 items-center">
                                <div class="relative xl:col-span-2">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="search" id="tk-filter-search" placeholder="Cari kategori atau catatan..." class="w-full pl-10 pr-4 py-2 border rounded-md text-sm bg-slate-50 focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <select id="tk-filter-jenis" class="w-full p-2 border rounded-md text-sm bg-slate-50 focus:ring-sky-500 focus:border-sky-500">
                                    <option value="Semua">Semua Tipe</option>
                                    <option value="Pendapatan">Pendapatan</option>
                                    <option value="Pengeluaran">Pengeluaran</option>
                                    <option value="Transfer">Transfer</option>
                                </select>
                                <div class="flex items-center gap-2">
                                    <input type="date" id="tk-filter-tanggal" class="w-full p-2 border rounded-md text-sm bg-slate-50 focus:ring-sky-500 focus:border-sky-500" title="Filter berdasarkan tanggal">
                                    <button id="tk-filter-reset" class="px-3 py-2 border rounded-md text-sm hover:bg-slate-100 transition-colors" title="Reset semua filter">
                                        <i class="fas fa-undo text-gray-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="transaksi-keuangan-list-container" class="flex-1 overflow-y-auto">
                            <!-- Riwayat akan dirender di sini -->
                        </div>

                        <div class="mt-auto pt-4">
                             <div class="bg-green-100 p-4 rounded-lg shadow">
                                <h4 class="text-sm font-medium text-green-800">Total Laba Bersih Hari Ini (dari Transaksi Keuangan)</h4>
                                <p id="laba-harian-total" class="text-2xl font-bold text-green-900">${formatCurrency(calculateFinancialProfitToday())}</p>
                            </div>
                        </div>
                    </div>
                 `;
                 renderTransaksiKeuanganList();
                 // Add listeners after rendering
                 document.getElementById('tambah-transaksi-keuangan-btn').addEventListener('click', () => showTransaksiKeuanganModal());
                 document.getElementById('tk-filter-search').addEventListener('input', renderTransaksiKeuanganList);
                 document.getElementById('tk-filter-jenis').addEventListener('change', renderTransaksiKeuanganList);
                 document.getElementById('tk-filter-tanggal').addEventListener('change', renderTransaksiKeuanganList);
                 document.getElementById('tk-filter-reset').addEventListener('click', () => {
                    document.getElementById('tk-filter-search').value = '';
                    document.getElementById('tk-filter-jenis').value = 'Semua';
                    document.getElementById('tk-filter-tanggal').value = '';
                    renderTransaksiKeuanganList();
                 });
            }

            function renderTransaksiKeuanganList() {
                const listContainer = document.getElementById('transaksi-keuangan-list-container');
                if (!listContainer) return;
                
                const searchTerm = document.getElementById('tk-filter-search')?.value.toLowerCase() || '';
                const filterJenis = document.getElementById('tk-filter-jenis')?.value || 'Semua';
                const filterTanggal = document.getElementById('tk-filter-tanggal')?.value || '';

                const transaksiData = appData.transaksiKeuangan || [];

                const filtered = transaksiData.filter(trx => {
                    const searchMatch = !searchTerm || trx.category.toLowerCase().includes(searchTerm) || (trx.notes && trx.notes.toLowerCase().includes(searchTerm));
                    const jenisMatch = filterJenis === 'Semua' || trx.type === filterJenis;
                    const tanggalMatch = !filterTanggal || toLocalDateString(new Date(trx.date)) === filterTanggal;
                    return searchMatch && jenisMatch && tanggalMatch;
                });
                
                const sorted = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

                const groupedByDate = sorted.reduce((acc, trx) => {
                    const dateStr = toLocalDateString(new Date(trx.date));
                    if (!acc[dateStr]) acc[dateStr] = [];
                    acc[dateStr].push(trx);
                    return acc;
                }, {});

                if (Object.keys(groupedByDate).length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-10"><p class="text-gray-500">Belum ada riwayat transaksi keuangan.</p></div>';
                    return;
                }
                
                let groupedHTML = '';
                const todayStr = toLocalDateString(new Date());
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = toLocalDateString(yesterday);

                for (const dateStr in groupedByDate) {
                     let dateLabel = new Date(dateStr+'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                     if (dateStr === todayStr) dateLabel = 'Hari Ini';
                     else if (dateStr === yesterdayStr) dateLabel = 'Kemarin';

                     const tableRows = groupedByDate[dateStr].map(trx => {
                        let amountColor = 'text-gray-800';
                        if (trx.type === 'Pendapatan') amountColor = 'text-green-600';
                        else if (trx.type === 'Pengeluaran') amountColor = 'text-rose-600';
                        
                        const typeLabel = `<span class="px-2 py-0.5 rounded-full text-xs font-semibold ${
                            trx.type === 'Pendapatan' ? 'bg-blue-700 text-blue-100' :
                            trx.type === 'Pengeluaran' ? 'bg-red-700 text-red-100' :
                            'bg-green-700 text-green-100'
                        }">${trx.type}</span>`;
                        
                        return `
                            <tr class="hover:bg-slate-50">
                                <td class="p-3 text-sm text-gray-700">${typeLabel}</td>
                                <td class="p-3 text-sm text-gray-700">${trx.category}</td>
                                <td class="p-3 text-sm text-gray-500">${trx.fromAccount || '-'}</td>
                                <td class="p-3 text-sm text-gray-500">${trx.toAccount || '-'}</td>
                                <td class="p-3 text-sm font-semibold text-right ${amountColor}">${formatCurrency(trx.amount)}</td>
                                <td class="p-3 text-sm text-gray-500 truncate" title="${trx.notes || ''}">${trx.notes || '-'}</td>
                                <td class="p-3 text-sm">
                                    <div class="flex items-center justify-center gap-3">
                                        <button class="edit-tk-btn text-sky-500 hover:text-sky-700" data-id="${trx.id}" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                                        <button class="delete-tk-btn text-rose-500 hover:text-rose-700" data-id="${trx.id}" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `;
                     }).join('');

                     groupedHTML += `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-600 text-sm mb-2 px-1">${dateLabel}</h4>
                             <div class="overflow-x-auto bg-white rounded-lg shadow">
                                <table class="w-full">
                                    <thead class="bg-slate-50 border-b-2 border-slate-200">
                                        <tr>
                                            <th class="w-1/12 p-3 text-sm font-semibold tracking-wide text-left">Tipe</th>
                                            <th class="w-2/12 p-3 text-sm font-semibold tracking-wide text-left">Kategori</th>
                                            <th class="w-2/12 p-3 text-sm font-semibold tracking-wide text-left">Dari Akun</th>
                                            <th class="w-2/12 p-3 text-sm font-semibold tracking-wide text-left">Ke Akun</th>
                                            <th class="w-2/12 p-3 text-sm font-semibold tracking-wide text-right">Jumlah</th>
                                            <th class="w-2/12 p-3 text-sm font-semibold tracking-wide text-left">Catatan</th>
                                            <th class="w-1/12 p-3 text-sm font-semibold tracking-wide text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">${tableRows}</tbody>
                                </table>
                            </div>
                        </div>
                     `;
                }
                 listContainer.innerHTML = groupedHTML;
            }

            // --- FUNGSI MODAL TRANSAKSI KEUANGAN ---
            const tkModal = document.getElementById('transaksi-keuangan-modal');
            const tkForm = document.getElementById('transaksi-keuangan-form');
            
            function showTransaksiKeuanganModal(trx = null) {
                 tkForm.reset();
                 const modalTitle = document.getElementById('transaksi-keuangan-modal-title');
                 const idInput = document.getElementById('tk-id');
                 const tipeSelect = document.getElementById('tk-tipe');
                 const dariAkunSelect = document.getElementById('tk-dari-akun');
                 const keAkunSelect = document.getElementById('tk-ke-akun');
                 const akunSelect = document.getElementById('tk-akun');
                 const kategoriSelect = document.getElementById('tk-kategori');
                 
                 const akunOptionsHTML = appData.akun.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
                 dariAkunSelect.innerHTML = akunOptionsHTML;
                 keAkunSelect.innerHTML = akunOptionsHTML;
                 akunSelect.innerHTML = akunOptionsHTML;
                 kategoriSelect.innerHTML = appData.kategori.map(c => `<option value="${c}">${c}</option>`).join('');

                 function toggleFields() {
                    const type = tipeSelect.value;
                    document.getElementById('tk-transfer-fields').classList.toggle('hidden', type !== 'Transfer');
                    document.getElementById('tk-single-account-field').classList.toggle('hidden', type === 'Transfer');
                    document.getElementById('tk-kategori-container').classList.toggle('hidden', type === 'Transfer');

                    const singleAccountLabel = document.querySelector('#tk-single-account-field label');
                    if(type === 'Pendapatan') singleAccountLabel.textContent = 'Ke Akun';
                    if(type === 'Pengeluaran') singleAccountLabel.textContent = 'Dari Akun';
                 }
                 
                 tipeSelect.onchange = toggleFields;

                 if (trx) {
                    modalTitle.textContent = "Edit Transaksi Keuangan";
                    idInput.value = trx.id;
                    document.getElementById('tk-tanggal').value = toLocalDateString(new Date(trx.date));
                    tipeSelect.value = trx.type;
                    
                    toggleFields(); // Call toggle after setting type to ensure correct fields are visible
                    
                    document.getElementById('tk-jumlah').value = trx.amount;
                    document.getElementById('tk-catatan').value = trx.notes;

                    if (trx.type === 'Transfer') {
                        document.getElementById('tk-dari-akun').value = trx.fromAccount;
                        document.getElementById('tk-ke-akun').value = trx.toAccount;
                    } else {
                        document.getElementById('tk-kategori').value = trx.category;
                        const singleAccountName = trx.type === 'Pendapatan' ? trx.toAccount : trx.fromAccount;
                        document.getElementById('tk-akun').value = singleAccountName;
                    }

                 } else {
                    modalTitle.textContent = "Tambah Transaksi Keuangan";
                    idInput.value = '';
                    document.getElementById('tk-tanggal').value = toLocalDateString(new Date());
                    toggleFields();
                 }

                 tkModal.classList.remove('hidden');
                 tkModal.classList.add('flex');
            }

            function hideTransaksiKeuanganModal() {
                tkModal.classList.add('hidden');
                tkModal.classList.remove('flex');
            }

            function handleSimpanTransaksiKeuangan() {
                const id = document.getElementById('tk-id').value;
                const date = document.getElementById('tk-tanggal').value;
                const type = document.getElementById('tk-tipe').value;
                const amount = parseFloat(document.getElementById('tk-jumlah').value);
                const notes = document.getElementById('tk-catatan').value;

                if (!date || !type || isNaN(amount) || amount <= 0) {
                    
                    return;
                }

                let fromAccountName = null;
                let toAccountName = null;
                let category = '';

                if (type === 'Transfer') {
                    fromAccountName = document.getElementById('tk-dari-akun').value;
                    toAccountName = document.getElementById('tk-ke-akun').value;
                    category = 'Transfer Antar Akun';
                    if (fromAccountName === toAccountName) {
                        
                        return;
                    }
                } else {
                    category = document.getElementById('tk-kategori').value;
                    const singleAccountName = document.getElementById('tk-akun').value;
                    if (type === 'Pendapatan') toAccountName = singleAccountName;
                    else fromAccountName = singleAccountName;
                }

                if (id) { // Editing
                    const trxIndex = appData.transaksiKeuangan.findIndex(t => t.id == id);
                    if (trxIndex === -1) return;

                    const oldTrx = appData.transaksiKeuangan[trxIndex];
                    const oldFrom = appData.akun.find(a => a.name === oldTrx.fromAccount);
                    const oldTo = appData.akun.find(a => a.name === oldTrx.toAccount);
                    if (oldFrom) oldFrom.balance += oldTrx.amount;
                    if (oldTo) oldTo.balance -= oldTrx.amount;

                    appData.transaksiKeuangan[trxIndex] = {
                        ...oldTrx,
                        date: new Date(date + 'T' + new Date(oldTrx.date).toTimeString().split(' ')[0]).toISOString(),
                        type, category, fromAccount: fromAccountName, toAccount: toAccountName, amount, notes
                    };
                    

                } else { // Adding
                    const newTransaction = {
                        id: Date.now(),
                        date: new Date(date + 'T' + new Date().toTimeString().split(' ')[0]).toISOString(),
                        type, category, fromAccount: fromAccountName, toAccount: toAccountName, amount, notes
                    };
                    if (!appData.transaksiKeuangan) appData.transaksiKeuangan = [];
                    appData.transaksiKeuangan.push(newTransaction);
                    
                }

                const newFrom = appData.akun.find(a => a.name === fromAccountName);
                const newTo = appData.akun.find(a => a.name === toAccountName);
                if (newFrom) newFrom.balance -= amount;
                if (newTo) newTo.balance += amount;

                saveData();
                hideTransaksiKeuanganModal();
                renderTransaksiPage();
            }
            
            function handleDeleteTransaksiKeuangan(id) {
                const trxIndex = (appData.transaksiKeuangan || []).findIndex(t => t.id == id);
                if (trxIndex === -1) return;
                const trx = appData.transaksiKeuangan[trxIndex];
                const message = `Yakin ingin menghapus transaksi "${trx.category}" senilai ${formatCurrency(trx.amount)}? Saldo akun akan dikembalikan.`;

                showConfirmationModal(message, () => {
                    const fromAccount = appData.akun.find(a => a.name === trx.fromAccount);
                    const toAccount = appData.akun.find(a => a.name === trx.toAccount);
                    if (fromAccount) fromAccount.balance += trx.amount;
                    if (toAccount) toAccount.balance -= trx.amount;

                    appData.transaksiKeuangan.splice(trxIndex, 1);
                    saveData();
                    renderTransaksiPage(); 
                    showNotification("Transaksi keuangan berhasil dihapus.", "success");
                });
            }


            // --- FUNGSI RENDER DINAMIS LAINNYA ---
            function renderProdukList() {
                const headerContainer = document.getElementById('produk-container-header');
                const listContainer = document.getElementById('produk-container-list');
                const footerContainer = document.getElementById('produk-container-footer');
                if (!headerContainer || !listContainer || !footerContainer) return;
                
                const totalProduk = appData.produk.length;
                const totalAset = appData.produk.reduce((sum, item) => sum + (item.hargaModal * item.stok), 0);

                const tableRows = appData.produk.map((item, index) => `
                    <tr class="hover:bg-slate-50">
                        <td class="py-2.5 px-3 text-sm text-gray-700">${item.name}</td>
                        <td class="py-2.5 px-3 text-sm text-gray-700">${formatCurrency(item.hargaModal)}</td>
                        <td class="py-2.5 px-3 text-sm text-gray-700">${formatCurrency(item.hargaJual)}</td>
                        <td class="py-2.5 px-3 text-sm text-gray-700">${item.stok}</td>
                        <td class="py-2.5 px-3 text-sm text-gray-700">
                            <div class="flex items-center space-x-3">
                                <button class="edit-btn text-sky-500 hover:text-sky-700" data-type="produk" data-index="${index}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="delete-btn text-rose-500 hover:text-rose-700" data-type="produk" data-index="${index}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                headerContainer.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                            <h3 class="text-xl font-semibold">Daftar Produk</h3>
                            <div class="flex items-center space-x-2">
                                <button id="export-produk-btn" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm flex items-center"><i class="fas fa-file-csv mr-2"></i>Export CSV</button>
                                <label class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm flex items-center cursor-pointer">
                                    <i class="fas fa-file-import mr-2"></i>Import CSV
                                    <input type="file" id="import-produk-input" class="hidden" accept=".csv">
                                </label>
                                <button class="add-btn px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 text-sm flex items-center" data-type="produk" data-title="Produk"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            </div>
                        </div>
                    </div>
                `;

                listContainer.innerHTML = `
                    <div class="overflow-x-auto bg-white rounded-lg shadow h-full">
                         <table class="w-full">
                            <thead class="bg-slate-50 border-b-2 border-slate-200 sticky top-0 z-10">
                                <tr>
                                    <th class="py-2 px-3 text-sm font-semibold tracking-wide text-left">Nama Produk</th>
                                    <th class="py-2 px-3 text-sm font-semibold tracking-wide text-left">Harga Modal</th>
                                    <th class="py-2 px-3 text-sm font-semibold tracking-wide text-left">Harga Jual</th>
                                    <th class="py-2 px-3 text-sm font-semibold tracking-wide text-left">Stok</th>
                                    <th class="py-2 px-3 text-sm font-semibold tracking-wide text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${tableRows.length > 0 ? tableRows : '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada produk.</td></tr>'}
                            </tbody>
                         </table>
                    </div>
                `;

                footerContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-sky-50 p-4 rounded-lg shadow">
                            <h4 class="text-sm font-medium text-sky-800">Total Jenis Produk</h4>
                            <p class="text-2xl font-bold text-sky-900">${totalProduk}</p>
                        </div>
                        <div class="bg-teal-50 p-4 rounded-lg shadow">
                            <h4 class="text-sm font-medium text-teal-800">Total Aset Produk (Modal)</h4>
                            <p class="text-2xl font-bold text-teal-900">${formatCurrency(totalAset)}</p>
                        </div>
                    </div>
                `;
            }
            
            // --- FUNGSI HALAMAN KASIR ---
            let kasirState = {
                activeTab: 'Produk',
                transactionDate: toLocalDateString(new Date()),
                cart: [],
                jasa: { name: '', modal: 0, jual: 0 },
                aplikasi: { jenis: '', akun: '', modal: 0, jual: 0 }
            };

            function renderKasirPage() {
                mainContent.innerHTML = `
                   <div class="flex flex-col lg:flex-row gap-6 h-full max-h-full overflow-hidden">
                        <!-- Kolom Kiri: Input & Keranjang -->
                        <div class="lg:w-[35%] flex flex-col gap-6">
                            <!-- Panel Atas: Tabs -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                 <nav class="flex space-x-2 bg-slate-100 p-1 rounded-xl">
                                    <button data-tab="Produk" class="kasir-tab-button flex-1 px-3 py-2 text-sm font-semibold rounded-lg flex items-center justify-center gap-2"><i class="fas fa-box-open"></i>Produk</button>
                                    <button data-tab="Jasa" class="kasir-tab-button flex-1 px-3 py-2 text-sm font-semibold rounded-lg flex items-center justify-center gap-2"><i class="fas fa-hand-sparkles"></i>Jasa</button>
                                    <button data-tab="Aplikasi" class="kasir-tab-button flex-1 px-3 py-2 text-sm font-semibold rounded-lg flex items-center justify-center gap-2"><i class="fas fa-mobile-alt"></i>Aplikasi</button>
                                </nav>
                            </div>
                            <!-- Panel Konten Tab -->
                            <div id="kasir-content" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                <!-- Konten dinamis -->
                            </div>
                             <!-- Keranjang -->
                            <div class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                                    <h3 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-shopping-cart text-sky-500"></i> Transaksi Saat Ini</h3>
                                    <input type="date" id="kasir-tanggal" class="border-gray-300 rounded-lg shadow-sm text-sm p-2 bg-slate-50 focus:ring-sky-500 focus:border-sky-500">
                                </div>
                                <div id="cart-items" class="flex-1 p-4 space-y-3 overflow-y-auto bg-slate-50/50">
                                    <!-- Item keranjang -->
                                </div>
                                <div id="kasir-footer" class="p-4 mt-auto border-t border-slate-200 bg-white rounded-b-xl">
                                    <!-- Total & Checkout -->
                                </div>
                            </div>
                        </div>

                        <!-- Kolom Kanan: Riwayat -->
                        <div class="lg:w-[65%] flex flex-col">
                             <div class="flex-1 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="p-4 border-b border-slate-200">
                                     <h3 class="text-lg font-bold flex items-center gap-2"><i class="fas fa-history text-sky-500"></i> Riwayat 3 Hari Terakhir</h3>
                                </div>
                                <div id="riwayat-list" class="flex-1 p-2 space-y-2 overflow-y-auto">
                                    <!-- Riwayat transaksi -->
                                </div>
                                <div id="summary-cards-container" class="p-4 border-t border-slate-200 bg-slate-50">
                                    <!-- Kartu rangkuman akan di-inject di sini -->
                                </div>
                            </div>
                        </div>
                   </div>
                `;
                
                document.getElementById('kasir-tanggal').value = kasirState.transactionDate;
                renderKasirContent();
                renderRiwayatTransaksi(); 
            }
            
            function renderKasirContent() {
                const kasirContent = document.getElementById('kasir-content');
                if(!kasirContent) return;

                let contentHTML = '';
                const inputClasses = "w-full p-3 mt-1 border border-gray-300 rounded-xl bg-white focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors text-sm";
                
                switch(kasirState.activeTab) {
                    case 'Produk':
                        const productOptions = appData.produk.map(p => `<option value="${p.name}">${p.name} (${formatCurrency(p.hargaJual)})</option>`).join('');
                        contentHTML = `
                            <div class="space-y-6">
                                <!-- Form 1: Dropdown Select -->
                                <div>
                                    <label for="product-dropdown" class="block text-sm font-medium text-slate-700">Pilih Produk dari Daftar</label>
                                    <div class="flex gap-2 mt-1">
                                        <select id="product-dropdown" class="${inputClasses} flex-1">
                                            ${productOptions}
                                        </select>
                                        <button id="add-from-dropdown-btn" class="px-4 bg-sky-600 text-white rounded-xl font-semibold hover:bg-sky-700 transition-colors flex items-center justify-center">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Form 2: Search by Name with Live Results -->
                                <div>
                                    <label for="product-search-input" class="block text-sm font-medium text-slate-700">Cari Produk by Nama</label>
                                    <div class="relative mt-1">
                                        <input type="text" id="product-search-input" class="${inputClasses}" placeholder="Ketik nama produk..." autocomplete="off">
                                        <div id="search-results-container" class="absolute z-20 w-full mt-1"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    
                    case 'Jasa':
                        contentHTML = `
                             <div class="flex flex-col h-full max-w-lg mx-auto">
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm font-medium text-slate-700">Nama Transaksi / Jasa</label>
                                        <input type="text" id="jasa-nama" class="${inputClasses}">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-sm font-medium text-slate-700">Harga Modal</label>
                                            <input type="number" id="jasa-modal" class="${inputClasses}">
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-slate-700">Harga Jual</label>
                                            <input type="number" id="jasa-jual" class="${inputClasses}">
                                        </div>
                                    </div>
                                    <div class="mt-6">
                                        <button id="checkout-jasa-btn" class="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold transition-all duration-300 hover:bg-sky-700 hover:shadow-lg hover:shadow-sky-200">
                                            <i class="fas fa-check-circle mr-2"></i>Checkout Jasa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    
                    case 'Aplikasi':
                        const jenisAplikasiOptions = appData.jenisAplikasi.map(item => `<option value="${item}">${item}</option>`).join('');
                        const akunOptions = appData.akun.map(item => `<option value="${item.name}">${item.name}</option>`).join('');
                        contentHTML = `
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-medium text-slate-700">Jenis Aplikasi</label>
                                        <select id="aplikasi-jenis" class="${inputClasses}">
                                            <option value="">Pilih Jenis</option>
                                            ${jenisAplikasiOptions}
                                        </select>
                                    </div>
                                     <div>
                                        <label class="text-sm font-medium text-slate-700">Dari Akun</label>
                                        <select id="aplikasi-akun" class="${inputClasses}">
                                             <option value="">Pilih Akun</option>
                                            ${akunOptions}
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                     <div>
                                        <label class="text-sm font-medium text-slate-700">Harga Modal</label>
                                        <input type="number" id="aplikasi-modal" class="${inputClasses}">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-slate-700">Harga Jual</label>
                                        <input type="number" id="aplikasi-jual" class="${inputClasses}">
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button id="checkout-aplikasi-btn" class="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold transition-all duration-300 hover:bg-sky-700 hover:shadow-lg hover:shadow-sky-200">
                                        <i class="fas fa-check-circle mr-2"></i>Checkout Aplikasi
                                    </button>
                                </div>
                            </div>
                        `;
                        break;
                }
                kasirContent.innerHTML = contentHTML;
                
                if (kasirState.activeTab === 'Jasa') {
                    document.getElementById('jasa-nama').value = kasirState.jasa.name;
                    document.getElementById('jasa-modal').value = kasirState.jasa.modal;
                    document.getElementById('jasa-jual').value = kasirState.jasa.jual;
                } else if (kasirState.activeTab === 'Aplikasi') {
                    document.getElementById('aplikasi-jenis').value = kasirState.aplikasi.jenis;
                    document.getElementById('aplikasi-akun').value = kasirState.aplikasi.akun;
                    document.getElementById('aplikasi-modal').value = kasirState.aplikasi.modal;
                    document.getElementById('aplikasi-jual').value = kasirState.aplikasi.jual;
                }

                renderCart();
                
                document.querySelectorAll('.kasir-tab-button').forEach(btn => {
                    if(btn.dataset.tab === kasirState.activeTab) {
                        btn.classList.add('bg-white', 'text-sky-600', 'shadow-sm');
                        btn.classList.remove('text-slate-600');
                    } else {
                        btn.classList.remove('bg-white', 'text-sky-600', 'shadow-sm');
                        btn.classList.add('text-slate-600');
                    }
                });
            }

            function renderCart() {
                const cartContainer = document.getElementById('cart-items');
                const kasirFooter = document.getElementById('kasir-footer');

                if (kasirState.cart.length === 0) {
                    cartContainer.innerHTML = '<p class="text-center text-sm text-gray-400 py-10">Keranjang masih kosong</p>';
                } else {
                     cartContainer.innerHTML = kasirState.cart.map((item, index) => `
                        <div class="flex items-center gap-3 bg-white p-2 rounded-lg border">
                            <div class="flex-1">
                                <p class="font-semibold text-sm text-gray-800">${item.name}</p>
                                <p class="text-xs text-gray-500">${formatCurrency(item.hargaJual)} x ${item.qty}</p>
                            </div>
                            <div class="flex items-center border rounded-lg">
                                <button data-index="${index}" class="cart-qty-change h-7 w-7 text-gray-600" data-amount="-1">&minus;</button>
                                <input type="number" class="cart-qty-input w-10 text-center border-none bg-transparent text-sm" value="${item.qty}" data-index="${index}" min="1">
                                <button data-index="${index}" class="cart-qty-change h-7 w-7 text-gray-600" data-amount="1">&plus;</button>
                            </div>
                            <p class="w-20 text-right text-sm font-semibold">${formatCurrency(item.hargaJual * item.qty)}</p>
                        </div>
                    `).join('');
                }

                const totalBelanja = kasirState.cart.reduce((sum, item) => sum + (item.hargaJual * item.qty), 0);
                 kasirFooter.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <p class="font-semibold text-gray-600">Total:</p>
                        <p id="cart-total" class="text-2xl font-bold text-gray-900">${formatCurrency(totalBelanja)}</p>
                    </div>
                    <button id="selesaikan-transaksi" class="w-full py-3 bg-sky-600 text-white rounded-xl font-semibold transition-all duration-300 ${totalBelanja === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-sky-700 hover:shadow-lg hover:shadow-sky-200'}">
                        <i class="fas fa-check-circle mr-2"></i>Selesaikan Transaksi
                    </button>
                `;
            }

            function handleAddToCart(productName) {
                 const product = appData.produk.find(p => p.name === productName);
                if(product) {
                    const existingItem = kasirState.cart.find(item => item.name === productName);
                    if (existingItem) {
                        if (existingItem.qty < product.stok) {
                            existingItem.qty++;
                        } else {
                            
                        }
                    } else {
                        if (product.stok > 0) {
                             kasirState.cart.push({ ...product, qty: 1 });
                        } else {
                             
                        }
                    }
                    renderCart();
                }
            }


            function renderRiwayatTransaksi() {
                const listContainer = document.getElementById('riwayat-list');
                if (!listContainer) return;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const threeDaysAgo = new Date(today);
                threeDaysAgo.setDate(today.getDate() - 2);

                let filtered = appData.transaksi.filter(trx => {
                    const trxDate = new Date(trx.date);
                    return trxDate >= threeDaysAgo;
                });

                const sorted = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (sorted.length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-10"><p class="text-gray-500 text-sm">Tidak ada riwayat transaksi dalam 3 hari terakhir.</p></div>';
                } else {
                    const groupedByDate = sorted.reduce((acc, trx) => {
                        const dateStr = toLocalDateString(new Date(trx.date));
                        if (!acc[dateStr]) acc[dateStr] = [];
                        acc[dateStr].push(trx);
                        return acc;
                    }, {});

                    const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

                    let html = '';
                    const todayStr = toLocalDateString(new Date());
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = toLocalDateString(yesterday);

                    sortedDates.forEach((dateStr, index) => {
                        let dateLabel = new Date(dateStr + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
                        if (dateStr === todayStr) dateLabel = 'Hari Ini';
                        else if (dateStr === yesterdayStr) dateLabel = 'Kemarin';

                        const transactionsHTML = groupedByDate[dateStr].map(trx => {
                            const trxDate = new Date(trx.date);
                            let iconClass, iconColor;
                            switch (trx.type) {
                                case 'Produk':
                                    iconClass = 'fa-box';
                                    iconColor = 'bg-blue-100 text-blue-600';
                                    break;
                                case 'Jasa':
                                    iconClass = 'fa-hand-sparkles';
                                    iconColor = 'bg-green-100 text-green-600';
                                    break;
                                case 'Aplikasi':
                                    iconClass = 'fa-mobile-alt';
                                    iconColor = 'bg-purple-100 text-purple-600';
                                    break;
                                default:
                                    iconClass = 'fa-dollar-sign';
                                    iconColor = 'bg-gray-100 text-gray-600';
                            }
                            
                            return `
                                <div class="bg-white rounded-lg p-3 flex items-start gap-3 hover:bg-slate-50 transition-colors duration-200 border-b last:border-0">
                                    <div class="flex-shrink-0 h-8 w-8 mt-1 flex items-center justify-center rounded-full ${iconColor}">
                                        <i class="fas ${iconClass} fa-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-semibold text-sm text-gray-800 truncate" title="${trx.detail}">${trx.detail}</p>
                                        <p class="text-xs text-gray-500">${trxDate.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</p>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <p class="font-semibold text-sm text-gray-900">${formatCurrency(trx.totalJual)}</p>
                                        <p class="text-xs ${trx.laba >= 0 ? 'text-green-600' : 'text-rose-600'}">Laba: ${formatCurrency(trx.laba)}</p>
                                    </div>
                                    <div class="flex items-center gap-0">
                                        <button class="edit-transaksi-btn text-gray-400 hover:text-sky-500 h-7 w-7 rounded-full flex items-center justify-center transition-colors" data-id="${trx.id}" title="Edit"><i class="fas fa-pencil-alt fa-xs"></i></button>
                                        <button class="delete-transaksi-btn text-gray-400 hover:text-rose-500 h-7 w-7 rounded-full flex items-center justify-center transition-colors" data-id="${trx.id}" title="Hapus"><i class="fas fa-trash-alt fa-xs"></i></button>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        html += `
                            <div>
                                <h4 class="font-semibold text-gray-500 text-sm my-2 px-2">${dateLabel}</h4>
                                ${transactionsHTML}
                            </div>
                        `;

                        if (index < sortedDates.length - 1) {
                            html += `<hr class="my-2 border-dashed border-slate-200">`;
                        }
                    });
                    listContainer.innerHTML = html;
                }
                
                // --- RENDER SUMMARY CARDS ---
                const summaryContainer = document.getElementById('summary-cards-container');
                if (summaryContainer) {
                    const todayStr = toLocalDateString(new Date());
                    const todaysTransactions = appData.transaksi.filter(trx => toLocalDateString(new Date(trx.date)) === todayStr);

                    const totalProdukTerjual = todaysTransactions
                        .filter(t => t.type === 'Produk')
                        .reduce((sum, trx) => sum + trx.items.reduce((itemSum, item) => itemSum + item.qty, 0), 0);
                        
                    const totalJasaTerjual = todaysTransactions.filter(t => t.type === 'Jasa' || t.type === 'Aplikasi').length;
                    
                    const totalLaba = todaysTransactions.reduce((sum, trx) => sum + trx.laba, 0);

                    summaryContainer.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-blue-800">Produk Terjual</p>
                                <p class="text-2xl font-bold text-blue-900">${totalProdukTerjual}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-green-800">Jasa/Aplikasi Terjual</p>
                                <p class="text-2xl font-bold text-green-900">${totalJasaTerjual}</p>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-amber-800">Total Laba Hari Ini</p>
                                <p class="text-2xl font-bold text-amber-900">${formatCurrency(totalLaba)}</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            function setupKasirListeners() {
                // Event listener untuk tab, input, dan tombol di dalam #main-content
                // Ini akan dijalankan sekali dan menggunakan event delegation
            }

            function handleSelesaikanTransaksi() {
                const type = kasirState.activeTab;
                const now = new Date();
                const transactionDate = new Date(kasirState.transactionDate + 'T' + now.toTimeString().split(' ')[0]);
                
                const labaBersihAkun = appData.akun.find(a => a.name === 'Laba Bersih');
                const modalAkun = appData.akun.find(a => a.name === 'Modal');
                const kasAkun = appData.akun.find(a => a.name === 'Kas / Cash');


                if (!labaBersihAkun || !modalAkun || !kasAkun) {
                    
                    return;
                }

                if (type === 'Produk') {
                    if (kasirState.cart.length === 0) return;
                    
                    // Iterasi setiap item di keranjang dan buat transaksi terpisah
                    kasirState.cart.forEach((item, index) => {
                        const totalModal = item.hargaModal * item.qty;
                        const totalJual = item.hargaJual * item.qty;
                        const laba = totalJual - totalModal;

                        let newTransaction = {
                            id: Date.now() + index, // Tambahkan index untuk memastikan ID unik
                            date: transactionDate.toISOString(),
                            type: 'Produk',
                            items: [{ name: item.name, qty: item.qty, hargaModal: item.hargaModal, hargaJual: item.hargaJual }],
                            totalModal: totalModal,
                            totalJual: totalJual,
                            laba: laba,
                            detail: `${item.name} (x${item.qty})` // Detail transaksi per produk
                        };

                        // Update saldo akun untuk setiap item
                        if(modalAkun) modalAkun.balance += newTransaction.totalModal;
                        if(labaBersihAkun) labaBersihAkun.balance += newTransaction.laba;
                        
                        // Kurangi stok produk
                        const product = appData.produk.find(p => p.name === item.name);
                        if (product) {
                            product.stok -= item.qty;
                        }
                        
                        // Masukkan transaksi individu ke riwayat
                        appData.transaksi.push(newTransaction);
                    });

                    kasirState.cart = []; // Kosongkan keranjang setelah semua item diproses
                    

                } else if (type === 'Jasa') {
                    if (!kasirState.jasa.name || kasirState.jasa.jual <= 0) {
                        
                        return;
                    }
                    let newTransaction = { 
                        id: Date.now(), 
                        date: transactionDate.toISOString(), 
                        type,
                        totalModal: kasirState.jasa.modal,
                        totalJual: kasirState.jasa.jual,
                        laba: kasirState.jasa.jual - kasirState.jasa.modal,
                        detail: kasirState.jasa.name
                    };
                    modalAkun.balance += newTransaction.totalModal;
                    labaBersihAkun.balance += newTransaction.laba;
                    appData.transaksi.push(newTransaction);
                    kasirState.jasa = { name: '', modal: 0, jual: 0 };
                    
                
                } else if (type === 'Aplikasi') {
                     if (!kasirState.aplikasi.jenis || !kasirState.aplikasi.akun || kasirState.aplikasi.jual <= 0) {
                        
                        return;
                     }
                    const sumberAkun = appData.akun.find(a => a.name === kasirState.aplikasi.akun);
                    if (!sumberAkun) { 
                        
                        return; 
                    }
                    
                    let newTransaction = { 
                        id: Date.now(), 
                        date: transactionDate.toISOString(), 
                        type,
                        totalModal: kasirState.aplikasi.modal,
                        totalJual: kasirState.aplikasi.jual,
                        laba: kasirState.aplikasi.jual - kasirState.aplikasi.modal,
                        detail: `${kasirState.aplikasi.jenis}`,
                        akun: kasirState.aplikasi.akun
                    };

                    sumberAkun.balance -= newTransaction.totalModal;
                    kasAkun.balance += newTransaction.totalModal;
                    labaBersihAkun.balance += newTransaction.laba;
                    appData.transaksi.push(newTransaction);
                    kasirState.aplikasi = { jenis: '', akun: '', modal: 0, jual: 0 };
                    
                }

                saveData();
                
                renderKasirPage();
            }
            
            // --- FUNGSI HAPUS TRANSAKSI ---
            function handleDeleteTransaksi(transactionId) {
                const trxIndex = appData.transaksi.findIndex(t => t.id == transactionId);
                if (trxIndex === -1) return;
                const trxToDelete = appData.transaksi[trxIndex];
                const message = `Apakah Anda yakin ingin menghapus transaksi "${trxToDelete.detail}"? Saldo akun terkait akan dikembalikan.`;
                showConfirmationModal(message, () => {
                    const labaBersihAkun = appData.akun.find(a => a.name === 'Laba Bersih');
                    const modalAkun = appData.akun.find(a => a.name === 'Modal');
                    const kasAkun = appData.akun.find(a => a.name === 'Kas / Cash');

                    // 1. Reverse Laba Bersih for all transaction types
                    if (labaBersihAkun) {
                        labaBersihAkun.balance -= trxToDelete.laba;
                    }

                    // 2. Reverse Modal/Kas based on transaction type
                    if (trxToDelete.type === 'Produk') {
                        // Kembalikan modal dari akun Modal
                        if(modalAkun) {
                            modalAkun.balance -= trxToDelete.totalModal;
                        }
                        // Kembalikan stok produk
                         trxToDelete.items.forEach(item => {
                            const product = appData.produk.find(p => p.name === item.name);
                            if (product) {
                                product.stok += item.qty;
                            }
                        });
                    } else if (trxToDelete.type === 'Jasa') {
                        // Kembalikan modal dari akun Modal
                        if(modalAkun) {
                            modalAkun.balance -= trxToDelete.totalModal;
                        }
                    } else if (trxToDelete.type === 'Aplikasi') {
                        // Kembalikan modal dari akun Kas/Cash
                        if (kasAkun) {
                            kasAkun.balance -= trxToDelete.totalModal;
                        }
                        // Kembalikan saldo ke akun sumber
                        const sumberAkun = appData.akun.find(a => a.name === trxToDelete.akun);
                        if(sumberAkun) {
                            sumberAkun.balance += trxToDelete.totalModal;
                        }
                    }
                    
                    // 3. Hapus transaksi dari data
                    appData.transaksi.splice(trxIndex, 1);
                    
                    // 4. Simpan perubahan dan render ulang
                    saveData();
                    renderRiwayatTransaksi();
                    
                });
            }


            // --- FUNGSI EDIT TRANSAKSI ---
            const trxEditModal = document.getElementById('transaksi-edit-modal');
            const trxEditModalTitle = document.getElementById('transaksi-edit-modal-title');
            const trxEditModalBody = document.getElementById('transaksi-edit-modal-body');
            const trxEditModalSave = document.getElementById('transaksi-edit-modal-save');
            const trxEditModalCancel = document.getElementById('transaksi-edit-modal-cancel');

            document.getElementById('tk-modal-cancel').addEventListener('click', hideTransaksiKeuanganModal);
            document.getElementById('tk-modal-save').addEventListener('click', handleSimpanTransaksiKeuangan);

            function showTransaksiEditModal(transactionId) {
                const trx = appData.transaksi.find(t => t.id == transactionId);
                if (!trx) return;

                trxEditModalTitle.textContent = `Edit Transaksi #${trx.id}`;
                let bodyHTML = `
                    <div>
                        <label class="text-sm font-medium">Tanggal Transaksi</label>
                        <input type="date" id="trx-edit-date" class="w-full mt-1 border-gray-300 rounded-md bg-slate-50" value="${toLocalDateString(new Date(trx.date))}">
                    </div>
                `;

                if (trx.type === 'Produk') {
                    bodyHTML += `
                        <div>
                            <label class="text-sm font-medium">Detail Transaksi</label>
                            <p class="mt-1 text-sm p-2 bg-slate-100 rounded-md">${trx.detail}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium">Total Modal (Read-only)</label>
                                <input type="number" id="trx-edit-modal" class="w-full mt-1 border-gray-300 rounded-md bg-slate-200" value="${trx.totalModal}" readonly>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Total Jual</label>
                                <input type="number" id="trx-edit-jual" class="w-full mt-1 border-gray-300 rounded-md bg-slate-50" value="${trx.totalJual}">
                            </div>
                        </div>
                    `;
                } else if (trx.type === 'Jasa') {
                    bodyHTML += `
                        <div>
                            <label class="text-sm font-medium">Nama Jasa</label>
                            <input type="text" id="trx-edit-detail" class="w-full mt-1 border-gray-300 rounded-md bg-slate-50" value="${trx.detail}">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium">Harga Modal</label>
                                <input type="number" id="trx-edit-modal" class="w-full mt-1 border-gray-300 rounded-md bg-slate-50" value="${trx.totalModal}">
                            </div>
                            <div>
                                <label class="text-sm font-medium">Harga Jual</label>
                                <input type="number" id="trx-edit-jual" class="w-full mt-1 border-gray-300 rounded-md bg-slate-50" value="${trx.totalJual}">
                            </div>
                        </div>
                    `;
                } else if (trx.type === 'Aplikasi') {
                    bodyHTML += `
                         <div>
                            <label class="text-sm font-medium">Detail Transaksi</label>
                            <input type="text" id="trx-edit-detail" class="w-full mt-1 border-gray-300 rounded-md bg-slate-50" value="${trx.detail}">
                         </div>
                         <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium">Harga Modal</label>
                                <input type="number" id="trx-edit-modal" class="w-full mt-1 border-gray-300 rounded-md bg-slate-50" value="${trx.totalModal}">
                            </div>
                            <div>
                                <label class="text-sm font-medium">Harga Jual</label>
                                <input type="number" id="trx-edit-jual" class="w-full mt-1 border-gray-300 rounded-md bg-slate-50" value="${trx.totalJual}">
                            </div>
                        </div>
                    `;
                }
                
                trxEditModalBody.innerHTML = bodyHTML;
                trxEditModal.classList.remove('hidden');
                trxEditModal.classList.add('flex');

                trxEditModalSave.onclick = () => handleUpdateTransaksi(trx.id);
            }

            function hideTransaksiEditModal() {
                trxEditModal.classList.add('hidden');
                trxEditModal.classList.remove('flex');
            }
            trxEditModalCancel.onclick = hideTransaksiEditModal;

            function handleUpdateTransaksi(transactionId) {
                const trxIndex = appData.transaksi.findIndex(t => t.id == transactionId);
                if (trxIndex === -1) return;

                const oldTrx = { ...appData.transaksi[trxIndex] };
                const labaBersihAkun = appData.akun.find(a => a.name === 'Laba Bersih');

                const newDateStr = document.getElementById('trx-edit-date').value;
                const oldDate = new Date(oldTrx.date);
                const newDate = new Date(newDateStr);
                newDate.setHours(oldDate.getHours(), oldDate.getMinutes(), oldDate.getSeconds(), oldDate.getMilliseconds());


                const newDetail = document.getElementById('trx-edit-detail')?.value || oldTrx.detail;
                const newTotalModal = parseFloat(document.getElementById('trx-edit-modal').value);
                const newTotalJual = parseFloat(document.getElementById('trx-edit-jual').value);

                const newLaba = newTotalJual - newTotalModal;
                const labaDelta = newLaba - oldTrx.laba;
                
                if (labaBersihAkun) labaBersihAkun.balance += labaDelta;

                if (oldTrx.type === 'Aplikasi' || oldTrx.type === 'Jasa') {
                    const modalDelta = newTotalModal - oldTrx.totalModal;
                    if(oldTrx.type === 'Aplikasi'){
                         const sumberAkun = appData.akun.find(a => a.name === oldTrx.akun);
                         if (sumberAkun) sumberAkun.balance -= modalDelta;
                    }
                }
                
                appData.transaksi[trxIndex] = {
                    ...oldTrx,
                    date: newDate.toISOString(),
                    detail: newDetail,
                    totalModal: newTotalModal,
                    totalJual: newTotalJual,
                    laba: newLaba
                };
                
                saveData();
                hideTransaksiEditModal();
                
                renderRiwayatTransaksi();
            }

            function renderList(dataType, containerId, title) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const listItems = appData[dataType].map((item, index) => `
                    <div class="flex items-center justify-between p-3 border-b last:border-b-0 hover:bg-slate-50">
                        <span class="text-gray-700">${item}</span>
                        <div class="space-x-2">
                            <button class="edit-btn text-gray-400 hover:text-sky-600 transition-colors" data-type="${dataType}" data-index="${index}" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-btn text-gray-400 hover:text-rose-600 transition-colors" data-type="${dataType}" data-index="${index}" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`).join('');
                
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="flex justify-between items-center p-4 border-b">
                            <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                            <button class="add-btn px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 text-sm flex items-center gap-2 font-semibold" data-type="${dataType}" data-title="${title}">
                                <i class="fas fa-plus"></i>Tambah Baru
                            </button>
                        </div>
                        <div>
                            ${listItems.length > 0 ? listItems : '<p class="text-center text-gray-500 py-8">Tidak ada data.</p>'}
                        </div>
                    </div>`;
            }

            function renderAkunList() {
                const container = document.getElementById('tab-akun');
                if (!container) return;
                const listItems = appData.akun.map((item, index) => `
                     <div class="flex items-center justify-between p-3 border-b last:border-b-0 hover:bg-slate-50">
                        <div>
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(item.balance)}</p>
                        </div>
                        <div class="space-x-2">
                            <button class="edit-btn text-gray-400 hover:text-sky-600 transition-colors" data-type="akun" data-index="${index}" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-btn text-gray-400 hover:text-rose-600 transition-colors" data-type="akun" data-index="${index}" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`).join('');
                
                container.innerHTML = `
                     <div class="bg-white rounded-lg shadow-md">
                        <div class="flex justify-between items-center p-4 border-b">
                            <h3 class="text-xl font-bold text-gray-800">Daftar Akun</h3>
                            <button class="add-btn px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 text-sm flex items-center gap-2 font-semibold" data-type="akun" data-title="Akun">
                                <i class="fas fa-plus"></i>Tambah Baru
                            </button>
                        </div>
                        <div>
                           ${listItems.length > 0 ? listItems : '<p class="text-center text-gray-500 py-8">Tidak ada data.</p>'}
                        </div>
                    </div>`;
            }

            // --- MODAL LOGIC ---
            const modal = document.getElementById('edit-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalInput = document.getElementById('modal-input');
            const modalSave = document.getElementById('modal-save');
            const modalCancel = document.getElementById('modal-cancel');
            function showModal(title, value, onSave) {
                modalTitle.textContent = title;
                modalInput.value = value;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                modalSave.onclick = () => { onSave(modalInput.value); hideModal(); };
            }
            function hideModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                modalSave.onclick = null;
            }
            modalCancel.onclick = hideModal;
            
            // --- MODAL AKUN LOGIC ---
            const akunModal = document.getElementById('akun-modal');
            const akunModalTitle = document.getElementById('akun-modal-title');
            const akunModalInputName = document.getElementById('akun-modal-input-name');
            const akunModalInputBalance = document.getElementById('akun-modal-input-balance');
            const akunModalSave = document.getElementById('akun-modal-save');
            const akunModalCancel = document.getElementById('akun-modal-cancel');
            function showAkunModal(title, item, onSave) {
                akunModalTitle.textContent = title;
                akunModalInputName.value = item.name;
                akunModalInputBalance.value = item.balance;
                akunModal.classList.remove('hidden');
                akunModal.classList.add('flex');
                akunModalSave.onclick = () => {
                    onSave({ name: akunModalInputName.value, balance: parseFloat(akunModalInputBalance.value) || 0 });
                    hideAkunModal();
                };
            }
            function hideAkunModal() {
                akunModal.classList.add('hidden');
                akunModal.classList.remove('flex');
                akunModalSave.onclick = null;
            }
            akunModalCancel.onclick = hideAkunModal;

            // --- MODAL HUTANG PIUTANG ---
            const hutangModal = document.getElementById('hutang-modal');
            function showHutangPiutangModal(hutang = null) {
                const form = document.getElementById('hutang-form');
                form.reset();
                
                const title = document.getElementById('hutang-modal-title');
                const saveBtn = document.getElementById('hutang-modal-save');
                const akunSelect = document.getElementById('hutang-sumber-akun');
                akunSelect.innerHTML = appData.akun.map(a => `<option value="${a.name}">${a.name}</option>`).join('');

                if (hutang) {
                    title.textContent = "Edit Hutang";
                    saveBtn.textContent = "Simpan Perubahan";
                    document.getElementById('hutang-id').value = hutang.id;
                    document.getElementById('hutang-tanggal').value = toLocalDateString(new Date(hutang.date));
                    document.getElementById('hutang-nama').value = hutang.nama;
                    document.getElementById('hutang-sumber-akun').value = hutang.sumberAkun;
                    document.getElementById('hutang-jumlah').value = hutang.jumlah;
                    document.getElementById('hutang-catatan').value = hutang.catatan;
                } else {
                    title.textContent = "Tambah Hutang Baru";
                    saveBtn.textContent = "Simpan";
                    document.getElementById('hutang-id').value = '';
                    document.getElementById('hutang-tanggal').value = toLocalDateString(new Date());
                }

                hutangModal.classList.remove('hidden');
                hutangModal.classList.add('flex');
            }

            function hideHutangPiutangModal() {
                hutangModal.classList.add('hidden');
                hutangModal.classList.remove('flex');
            }

            function handleSimpanHutang() {
                const id = document.getElementById('hutang-id').value;
                const tanggal = document.getElementById('hutang-tanggal').value;
                const nama = document.getElementById('hutang-nama').value;
                const sumberAkunName = document.getElementById('hutang-sumber-akun').value;
                const jumlah = parseFloat(document.getElementById('hutang-jumlah').value) || 0;
                const catatan = document.getElementById('hutang-catatan').value;

                if (!tanggal || !nama || !sumberAkunName || jumlah <= 0) {
                    showNotification("Harap isi semua kolom yang diperlukan.", "error");
                    return;
                }
                
                const sumberAkunObj = appData.akun.find(a => a.name === sumberAkunName);
                if (!sumberAkunObj) {
                    showNotification("Sumber akun tidak valid.", "error");
                    return;
                }

                const hutangPiutangAkun = appData.akun.find(a => a.name === 'Hutang Piutang');
                if (!hutangPiutangAkun) {
                    showNotification("Akun Hutang Piutang tidak ditemukan.", "error");
                    return;
                }
                
                if (id) { // Editing existing hutang
                    const hutangIndex = appData.hutangPiutang.findIndex(h => h.id == id);
                    if (hutangIndex === -1) return;
                    
                    const oldHutang = appData.hutangPiutang[hutangIndex];
                    const oldSumberAkunObj = appData.akun.find(a => a.name === oldHutang.sumberAkun);

                    if (oldHutang.status !== 'Lunas') {
                        // Reverse old transaction
                        if (oldSumberAkunObj) oldSumberAkunObj.balance += oldHutang.jumlah;
                        hutangPiutangAkun.balance -= oldHutang.jumlah;

                        // Apply new transaction
                        sumberAkunObj.balance -= jumlah;
                        hutangPiutangAkun.balance += jumlah;
                    }
                    
                    appData.hutangPiutang[hutangIndex] = { ...oldHutang, date: new Date(tanggal + 'T00:00:00').toISOString(), nama, sumberAkun: sumberAkunName, modal: 0, jumlah, catatan };
                    showNotification("Hutang berhasil diperbarui.", "success");

                } else { // Adding new hutang
                    sumberAkunObj.balance -= jumlah;
                    hutangPiutangAkun.balance += jumlah;
                    
                    const newHutang = {
                        id: Date.now(),
                        date: new Date(tanggal + 'T00:00:00').toISOString(),
                        nama,
                        sumberAkun: sumberAkunName,
                        modal: 0, 
                        jumlah,
                        catatan,
                        status: 'Belum Lunas'
                    };
                    if(!appData.hutangPiutang) appData.hutangPiutang = [];
                    appData.hutangPiutang.push(newHutang);
                    showNotification("Hutang baru berhasil ditambahkan.", "success");
                }
                
                saveData();
                renderHutangPiutangList();
                hideHutangPiutangModal();
            }

            function handleTandaiLunas(id) {
                const hutangIndex = appData.hutangPiutang.findIndex(h => h.id == id);
                if (hutangIndex === -1) return;

                const hutang = appData.hutangPiutang[hutangIndex];
                if (hutang.status === 'Lunas') {
                    return;
                }

                const kasAkun = appData.akun.find(a => a.name === 'Kas / Cash');
                const hutangPiutangAkun = appData.akun.find(a => a.name === 'Hutang Piutang');

                if (!kasAkun || !hutangPiutangAkun) {
                    showNotification("Akun 'Kas / Cash' atau 'Hutang Piutang' tidak ditemukan.", "error");
                    return;
                }

                hutangPiutangAkun.balance -= hutang.jumlah;
                kasAkun.balance += hutang.jumlah;
                
                hutang.status = 'Lunas';
                saveData();
                renderHutangPiutangList();
                showNotification(`Hutang ${hutang.nama} telah lunas.`, "success");
            }

            function handleHapusHutang(id) {
                 const hutangIndex = appData.hutangPiutang.findIndex(h => h.id == id);
                if (hutangIndex === -1) return;

                const hutang = appData.hutangPiutang[hutangIndex];
                
                let confirmationMessage = `Yakin ingin menghapus hutang dari ${hutang.nama}?`;
                if (hutang.status === 'Belum Lunas') {
                    confirmationMessage += ' Aksi ini akan mempengaruhi saldo akun terkait.';
                }

                showConfirmationModal(confirmationMessage, () => {
                    if (hutang.status === 'Belum Lunas') {
                        const hutangPiutangAkun = appData.akun.find(a => a.name === 'Hutang Piutang');
                        const sumberAkunObj = appData.akun.find(a => a.name === hutang.sumberAkun);
                        if (hutangPiutangAkun) {
                            hutangPiutangAkun.balance -= hutang.jumlah;
                        }
                        if (sumberAkunObj) {
                            sumberAkunObj.balance += hutang.jumlah;
                        }
                    } 
                    
                    appData.hutangPiutang.splice(hutangIndex, 1);
                    saveData();
                    renderHutangPiutangList();
                    showNotification("Hutang berhasil dihapus.", "success");
                });
            }

            document.getElementById('hutang-modal-cancel').addEventListener('click', hideHutangPiutangModal);
            document.getElementById('hutang-modal-save').addEventListener('click', handleSimpanHutang);

            // --- MODAL PRODUK LOGIC ---
            const produkModal = document.getElementById('produk-modal');
            const produkModalTitle = document.getElementById('produk-modal-title');
            const produkModalInputName = document.getElementById('produk-modal-input-name');
            const produkModalInputModal = document.getElementById('produk-modal-input-modal');
            const produkModalInputJual = document.getElementById('produk-modal-input-jual');
            const produkModalInputStok = document.getElementById('produk-modal-input-stok');
            const produkModalSave = document.getElementById('produk-modal-save');
            const produkModalCancel = document.getElementById('produk-modal-cancel');
            function showProdukModal(title, item, onSave) {
                produkModalTitle.textContent = title;
                produkModalInputName.value = item.name;
                produkModalInputModal.value = item.hargaModal;
                produkModalInputJual.value = item.hargaJual;
                produkModalInputStok.value = item.stok;
                produkModal.classList.remove('hidden');
                produkModal.classList.add('flex');
                produkModalSave.onclick = () => {
                    onSave({
                        name: produkModalInputName.value,
                        hargaModal: parseFloat(produkModalInputModal.value) || 0,
                        hargaJual: parseFloat(produkModalInputJual.value) || 0,
                        stok: parseInt(produkModalInputStok.value) || 0
                    });
                    hideProdukModal();
                };
            }
            function hideProdukModal() {
                produkModal.classList.add('hidden');
                produkModal.classList.remove('flex');
                produkModalSave.onclick = null;
            }
            produkModalCancel.onclick = hideProdukModal;


            // --- EVENT HANDLING (Delegation) ---
            mainContent.addEventListener('click', e => {
                const target = e.target;
                
                // Sembunyikan hasil pencarian jika mengklik di luar area pencarian
                if (!target.closest('#product-search-input') && !target.closest('#search-results-container')) {
                    const resultsContainer = document.getElementById('search-results-container');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '';
                    }
                }

                const button = target.closest('button');
                if (button) {
                     const { type, index, title, id } = button.dataset;

                    if (button.id === 'toggle-lunas-history') {
                        const historyContainer = document.getElementById('lunas-history-container');
                        const icon = document.getElementById('toggle-lunas-icon');
                        if (historyContainer && icon) {
                            const isHidden = historyContainer.classList.toggle('hidden');
                            icon.classList.toggle('fa-chevron-down', isHidden);
                            icon.classList.toggle('fa-chevron-up', !isHidden);
                            if (!isHidden) {
                                historyContainer.classList.remove('animate-fade-in');
                                void historyContainer.offsetWidth;
                                historyContainer.classList.add('animate-fade-in');
                            }
                        }
                        return;
                    }
                    
                    // --- KASIR PAGE ---
                    if (button.classList.contains('kasir-tab-button')) {
                        kasirState.activeTab = button.dataset.tab;
                        renderKasirContent();
                        return;
                    }
                    if (button.id === 'add-from-dropdown-btn') {
                        const dropdown = document.getElementById('product-dropdown');
                        if (dropdown && dropdown.value) handleAddToCart(dropdown.value);
                        return;
                    }
                    const qtyChangeBtn = button.closest('.cart-qty-change');
                    if (qtyChangeBtn) {
                        const index = parseInt(qtyChangeBtn.dataset.index);
                        const amount = parseInt(qtyChangeBtn.dataset.amount);
                        const item = kasirState.cart[index];
                        const product = appData.produk.find(p => p.name === item.name);
                        
                        let newQty = item.qty + amount;
                         if (product && newQty > product.stok) {
                            return;
                        }
                        if (newQty <= 0) {
                            kasirState.cart.splice(index, 1);
                        } else {
                            item.qty = newQty;
                        }
                        renderCart();
                        return;
                    }
                    if (['selesaikan-transaksi', 'checkout-jasa-btn', 'checkout-aplikasi-btn'].includes(button.id)) {
                        if (!button.classList.contains('opacity-50')) handleSelesaikanTransaksi();
                        return;
                    }
                    const editTrxBtn = button.closest('.edit-transaksi-btn');
                    if(editTrxBtn) {
                        showTransaksiEditModal(editTrxBtn.dataset.id);
                        return;
                    }
                    const deleteTrxBtn = button.closest('.delete-transaksi-btn');
                    if(deleteTrxBtn) {
                        handleDeleteTransaksi(deleteTrxBtn.dataset.id);
                        return;
                    }

                    // --- HUTANG PIUTANG PAGE ---
                    if (button.classList.contains('lunas-btn')) {
                        handleTandaiLunas(id);
                        return;
                    }
                    if (button.classList.contains('edit-hutang-btn')) {
                        const hutangToEdit = appData.hutangPiutang.find(h => h.id == id);
                        if (hutangToEdit) showHutangPiutangModal(hutangToEdit);
                        return;
                    }
                    if (button.classList.contains('hapus-hutang-btn')) {
                        handleHapusHutang(id);
                        return;
                    }

                    // --- TRANSAKSI KEUANGAN PAGE ---
                    if (button.classList.contains('edit-tk-btn')) {
                        const trxToEdit = appData.transaksiKeuangan.find(t => t.id == id);
                        if (trxToEdit) showTransaksiKeuanganModal(trxToEdit);
                        return;
                    }
                    if (button.classList.contains('delete-tk-btn')) {
                        handleDeleteTransaksiKeuangan(id);
                        return;
                    }

                    // --- PENGATURAN & PRODUK PAGES ---
                    if (button.id === 'export-produk-btn') {
                        if (appData.produk.length === 0) { return; }
                        const worksheet = XLSX.utils.json_to_sheet(appData.produk);
                        const csvOutput = XLSX.utils.sheet_to_csv(worksheet);
                        const blob = new Blob([csvOutput], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Backup-Produk-${toLocalDateString(new Date())}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                        return;
                    }
                    if (button.id === 'backup-btn') {
                        const dataStr = JSON.stringify(appData, null, 2);
                        const blob = new Blob([dataStr], {type: "application/json"});
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backup-aplikasi-${new Date().toISOString().slice(0,10)}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        return;
                    }

                    if (button.classList.contains('add-btn')) {
                        if (type === 'produk') {
                            showProdukModal('Tambah Produk Baru', { name: '', hargaModal: 0, hargaJual: 0, stok: 0 }, (newItem) => {
                                if (newItem.name) { appData.produk.push(newItem); saveData(); renderProdukList(); }
                            });
                        } else if (type === 'akun') {
                            showAkunModal('Tambah Akun Baru', { name: '', balance: 0 }, (newItem) => {
                                if (newItem.name) { appData.akun.push(newItem); saveData(); refreshSettingsPage(); }
                            });
                        } else { 
                            showModal(`Tambah ${title} Baru`, '', (newValue) => {
                                if (newValue && !appData[type].includes(newValue)) { appData[type].push(newValue); saveData(); refreshSettingsPage(); }
                            });
                        }
                    } else if (button.classList.contains('edit-btn')) {
                        if (type === 'produk') {
                            showProdukModal('Edit Produk', { ...appData.produk[index] }, (updatedItem) => {
                                if (updatedItem.name) { appData.produk[index] = updatedItem; saveData(); renderProdukList(); }
                            });
                        } else if (type === 'akun') {
                            showAkunModal('Edit Akun', { ...appData.akun[index] }, (updatedItem) => {
                                if (updatedItem.name) { appData.akun[index] = updatedItem; saveData(); refreshSettingsPage(); }
                            });
                        } else { 
                            showModal(`Edit Item`, appData[type][index], (newValue) => {
                                if (newValue) { appData[type][index] = newValue; saveData(); refreshSettingsPage(); }
                            });
                        }
                    } else if (button.classList.contains('delete-btn')) {
                        const itemToDelete = appData[type][index];
                        const itemName = typeof itemToDelete === 'object' ? itemToDelete.name : itemToDelete;
                        const message = `Apakah Anda yakin ingin menghapus "${itemName}"?`;
                        showConfirmationModal(message, () => {
                            appData[type].splice(index, 1);
                            saveData();
                            if (type === 'produk') { renderProdukList(); } else { refreshSettingsPage(); }
                        });
                    }
                }
                
                const searchResultItem = target.closest('.search-result-item');
                if (searchResultItem) {
                    const productName = searchResultItem.dataset.productName;
                    handleAddToCart(productName);
                    document.getElementById('product-search-input').value = '';
                    const resultsContainer = document.getElementById('search-results-container');
                    if(resultsContainer) resultsContainer.innerHTML = '';
                    return;
                }
            });

             // --- COMBINED CHANGE/INPUT/KEYUP LISTENERS ---
             mainContent.addEventListener('input', e => {
                if (e.target.id === 'product-search-input') {
                    const searchTerm = e.target.value;
                    const resultsContainer = document.getElementById('search-results-container');
                    if (!resultsContainer) return;
                    if (searchTerm.length < 1) { resultsContainer.innerHTML = ''; return; }
                    const filteredProducts = appData.produk.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
                    if (filteredProducts.length > 0) {
                        resultsContainer.innerHTML = `<div class="bg-white border border-slate-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">${filteredProducts.map(p => `<div class="p-3 hover:bg-slate-100 cursor-pointer search-result-item border-b last:border-b-0" data-product-name="${p.name}"><p class="font-medium text-sm text-gray-800">${p.name}</p><p class="text-xs text-gray-500">Stok: ${p.stok}</p></div>`).join('')}</div>`;
                    } else {
                        resultsContainer.innerHTML = `<div class="bg-white border border-slate-300 rounded-lg shadow-lg p-3 text-center text-sm text-gray-500">Produk tidak ditemukan</div>`;
                    }
                    return;
                }
                if (e.target.id === 'kasir-tanggal') kasirState.transactionDate = e.target.value;
                if (e.target.id === 'jasa-nama') kasirState.jasa.name = e.target.value;
                if (e.target.id === 'jasa-modal') kasirState.jasa.modal = parseFloat(e.target.value) || 0;
                if (e.target.id === 'jasa-jual') kasirState.jasa.jual = parseFloat(e.target.value) || 0;
                if (e.target.id === 'aplikasi-jenis') kasirState.aplikasi.jenis = e.target.value;
                if (e.target.id === 'aplikasi-akun') kasirState.aplikasi.akun = e.target.value;
                if (e.target.id === 'aplikasi-modal') kasirState.aplikasi.modal = parseFloat(e.target.value) || 0;
                if (e.target.id === 'aplikasi-jual') kasirState.aplikasi.jual = parseFloat(e.target.value) || 0;
                if (e.target.matches('#filter-search, #filter-jenis')) { renderRiwayatTransaksi(); }
                if (e.target.matches('.cart-qty-input')) {
                    const index = parseInt(e.target.dataset.index);
                    const newQty = parseInt(e.target.value);
                    if (newQty > 0) {
                        const item = kasirState.cart[index];
                        const product = appData.produk.find(p => p.name === item.name);
                        if(product && newQty > product.stok) {
                            e.target.value = product.stok;
                            item.qty = product.stok;
                        } else {
                            item.qty = newQty;
                        }
                    } else {
                        kasirState.cart.splice(index, 1);
                    }
                    renderCart();
                }
             });

            mainContent.addEventListener('change', e => {
                if (['filter-jenis', 'filter-tanggal'].includes(e.target.id)) { renderRiwayatTransaksi(); return; }
                const file = e.target.files ? e.target.files[0] : null;
                if (!file) return;
                if (e.target.id === 'import-produk-input') {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = new Uint8Array(event.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            if (workbook && workbook.SheetNames && workbook.SheetNames.length > 0) {
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                const importedData = XLSX.utils.sheet_to_json(worksheet);
                                if (Array.isArray(importedData) && importedData.length > 0) {
                                    const firstItem = importedData[0];
                                    if (firstItem && 'name' in firstItem && 'hargaModal' in firstItem && 'hargaJual' in firstItem && 'stok' in firstItem) {
                                        appData.produk = importedData.map(item => ({
                                            name: String(item.name || ''),
                                            hargaModal: parseFloat(item.hargaModal || 0),
                                            hargaJual: parseFloat(item.hargaJual || 0),
                                            stok: parseInt(item.stok || 0)
                                        }));
                                        saveData(); renderProdukList();
                                    }
                                }
                            }
                        } catch (err) { console.error("Import error:", err); }
                    };
                    reader.readAsArrayBuffer(file);
                    e.target.value = '';
                } else if (e.target.id === 'restore-input') {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                         try {
                            const importedData = JSON.parse(event.target.result);
                            if (importedData.kategori && importedData.akun && importedData.produk) {
                                appData = importedData;
                                saveData();
                                if(document.getElementById('settings-container')) { refreshSettingsPage(); }
                            }
                        } catch (err) { console.error("Restore error:", err); }
                    };
                    reader.readAsText(file);
                    e.target.value = '';
                }
             });
             
            mainContent.addEventListener('keyup', e => {
                if (e.key === 'Enter' && e.target.id === 'product-search-input') { e.preventDefault(); }
            });

            function refreshSettingsPage() {
                if (!document.getElementById('settings-menu')) return;
                 renderList('kategori', 'tab-kategori', 'Daftar Kategori');
                 renderAkunList();
                 renderList('jenisAplikasi', 'tab-jenis-aplikasi', 'Daftar Jenis Aplikasi');
                 renderList('pelanggan', 'tab-pelanggan', 'Daftar Pelanggan');
                 renderList('pengguna', 'tab-pengguna', 'Daftar Pengguna');
            }

            function initializeSettingsTabs() {
                if (!document.getElementById('settings-menu')) return;
                
                const tabButtons = document.querySelectorAll('.settings-tab-button');
                const tabPanels = document.querySelectorAll('.settings-tab-panel');

                function setActiveTab(activeButton) {
                    if (!activeButton) return;
                    const tabId = activeButton.dataset.tab;

                    tabButtons.forEach(btn => {
                        btn.classList.remove('bg-sky-100', 'text-sky-700');
                        btn.classList.add('text-gray-600', 'hover:bg-gray-100', 'hover:text-gray-900');
                    });
                    activeButton.classList.add('bg-sky-100', 'text-sky-700');
                    activeButton.classList.remove('text-gray-600', 'hover:bg-gray-100', 'hover:text-gray-900');


                    tabPanels.forEach(panel => {
                        if (panel.id === 'tab-' + tabId) {
                            panel.classList.remove('hidden');
                            panel.classList.remove('animate-fade-in');
                            void panel.offsetWidth; 
                            panel.classList.add('animate-fade-in');
                        } else {
                            panel.classList.add('hidden');
                        }
                    });
                }
                
                refreshSettingsPage(); 

                if (tabButtons.length > 0) {
                    setActiveTab(tabButtons[0]);
                }

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        setActiveTab(button);
                    });
                });
            }

            // --- FUNGSI UTAMA ---
            function loadPage(pageName) {
                // Reset kasir state if navigating away from it
                if(pageName !== 'kasir') {
                    kasirState = { 
                        activeTab: 'Produk',
                        transactionDate: toLocalDateString(new Date()),
                        cart: [], 
                        jasa: { name: '', modal: 0, jual: 0 }, 
                        aplikasi: { jenis: '', akun: '', modal: 0, jual: 0 } 
                    };
                }
                
                const pageData = pages[pageName] || { title: 'Halaman Tidak Ditemukan', content: '<p>Konten tidak tersedia.</p>'};
                document.title = `Dasbor - ${pageData.title}`;

                if (pageData.render) {
                    pageData.render();
                } else {
                    mainContent.innerHTML = pageData.content || '';
                }
                
                // Post-render initialization
                if (pageName === 'pengaturan') {
                    initializeSettingsTabs();
                } else if (pageName === 'produk') {
                    renderProdukList();
                } else if (pageName === 'laporan') {
                    initializeLaporanTabs();
                }


                // Tutup sidebar mobile setelah navigasi
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            }
            
            function setActiveLink(activeLink) {
                if (!activeLink) return;
                navLinks.forEach(link => link.classList.remove('bg-slate-700', 'text-white', 'font-semibold'));
                activeLink.classList.add('bg-slate-700', 'text-white', 'font-semibold');
            }
            
            // --- EVENT LISTENERS UTAMA ---
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageName = link.dataset.page;
                    loadPage(pageName);
                    setActiveLink(e.currentTarget);
                });
            });
            
            function toggleSidebar() {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('hidden');
            }
            
            mobileMenuButton.addEventListener('click', toggleSidebar);
            closeMenuButton.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // --- INISIALISASI ---
            loadPage('dashboard');
            setActiveLink(document.querySelector('.nav-link[data-page="dashboard"]'));
            renderSidebarAkunList();
            updateHeaderCards();
        });
    </script>
</body>
</html>

